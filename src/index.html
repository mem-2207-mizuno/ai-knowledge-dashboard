<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Knowledge Dashboard</title>
  <!-- Markdownãƒ‘ãƒ¼ã‚µãƒ¼ -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <style>
    :root {
      --bg: #f7f6f3;
      --sidebar-bg: #fbfaf7;
      --border: #e6e3dc;
      --primary: #5b6dff;
      --primary-soft: #eef0ff;
      --text: #2f3437;
      --muted: #747a80;
      --card-bg: #ffffff;
      --accent: #f5f1ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 300px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      padding: 32px 28px;
      display: flex;
      flex-direction: column;
      gap: 32px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }

    .primary-button {
      background: var(--text);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 18px;
      font-size: 15px;
      cursor: pointer;
      transition: opacity 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .primary-button:hover {
      opacity: 0.85;
    }

    .sidebar-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .search-box {
      display: flex;
      gap: 8px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px;
    }

    .search-box input {
      border: none;
      flex: 1;
      padding: 8px 10px;
      font-size: 14px;
      background: transparent;
    }

    .search-box input:focus {
      outline: none;
    }

    .search-box button {
      border: none;
      background: var(--primary);
      color: white;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 14px;
    }

    .nav-menu,
    .category-list,
    .tags-filter {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
      transition: background 0.2s, border 0.2s;
    }

    .nav-item.active {
      background: var(--primary-soft);
      border-color: var(--primary);
    }

    .category-chip {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 8px 12px;
      text-align: left;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s, border 0.2s;
    }

    .category-chip.active {
      border-color: var(--primary);
      background: var(--primary-soft);
      color: var(--primary);
    }

    .tags-filter {
      flex-direction: row;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag-chip {
      padding: 6px 10px;
      background: #f0efeb;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .tag-chip.active {
      background: var(--accent);
      border-color: var(--primary);
      color: var(--primary);
    }

    .main-content {
      flex: 1;
      padding: 40px 48px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .main-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .main-header h1 {
      font-size: 28px;
      font-weight: 700;
    }

    .main-header p {
      color: var(--muted);
      font-size: 15px;
    }

    .insight-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .insight-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .insight-label {
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .insight-value {
      font-size: 24px;
      font-weight: 600;
    }

    .knowledge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .knowledge-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 10px 30px rgba(15, 15, 15, 0.04);
    }

    .knowledge-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(15, 15, 15, 0.08);
    }

    .card-cover {
      width: 100%;
      height: 160px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      background-color: #f2f1ed;
    }

    .card-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    .category-badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent);
      color: var(--primary);
      font-weight: 600;
      font-size: 12px;
    }

    .status-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #f0f0f0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .card-description {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .card-tag {
      padding: 4px 8px;
      border-radius: 999px;
      background: #f0efeb;
      font-size: 12px;
    }

    .card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    .like-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #f3f2ef;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s, border 0.2s;
    }

    .like-button:hover {
      background: #ffecef;
    }

    .like-button.liked {
      background: #ffdee5;
      border-color: #ff8a9a;
      color: #d62947;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 18px;
      padding: 28px;
      max-width: 920px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-title-group h2 {
      font-size: 24px;
      margin: 0;
    }

    .close-button {
      border: none;
      background: transparent;
      font-size: 28px;
      cursor: pointer;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .loading,
    .error {
      padding: 24px;
      border-radius: 12px;
      background: #fff;
      border: 1px dashed var(--border);
      text-align: center;
      color: var(--muted);
    }

    .markdown-content {
      background: #f8f7f3;
      padding: 16px;
      border-radius: 12px;
    }
  </style>
</head>

<body>
  <!-- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾© -->
  <script>
    const SERVER_DATA = {
      initialData: <?!= initialData ?>,
      initialId: <?= initialId !== null ? initialId : 'null' ?>,
      appUrl: "<?!= appUrl ?>"
    };
  </script>

    <div class="layout">
    <aside class="sidebar">
      <div class="logo">ğŸ§  AI Knowledge</div>
      <button class="primary-button" onclick="openAddModal()">+ ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ </button>

      <div class="sidebar-section">
        <div class="section-title">æ¤œç´¢</div>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
          <button onclick="searchKnowledge()">æ¤œç´¢</button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-title">ãƒ“ãƒ¥ãƒ¼</div>
        <div class="nav-menu">
          <button class="nav-item active" data-view="all" onclick="setView('all')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
          <button class="nav-item" data-view="favorites" onclick="setView('favorites')">â­ ãŠæ°—ã«å…¥ã‚Š</button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-title">ã‚«ãƒ†ã‚´ãƒª</div>
        <div class="category-list">
          <button class="category-chip active" data-category="all" onclick="setCategory('all')">ğŸŒ ã™ã¹ã¦</button>
          <button class="category-chip" data-category="article" onclick="setCategory('article')">ğŸ“° æ°—ã«ãªã‚‹è¨˜äº‹</button>
          <button class="category-chip" data-category="question" onclick="setCategory('question')">â“ ç›¸è«‡ãƒ»è³ªå•</button>
          <button class="category-chip" data-category="recruitment" onclick="setCategory('recruitment')">ğŸ¤ ä»²é–“å‹Ÿé›†</button>
          <button class="category-chip" data-category="showcase" onclick="setCategory('showcase')">ğŸ æˆæœç‰©ç´¹ä»‹</button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-title">ã‚¿ã‚°</div>
        <div id="tagsFilter" class="tags-filter"></div>
      </div>
    </aside>

    <main class="main-content">
      <div class="main-header">
        <h1>AI Knowledge Dashboard</h1>
        <p>ãƒãƒ¼ãƒ ã®ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ¤œç´¢ãƒ»æ•´ç†ã—ã€URL å…±æœ‰ã‚„ã‚¿ã‚°ã§ç´ æ—©ãã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ Notion ãƒ©ã‚¤ã‚¯ãªãƒ“ãƒ¥ãƒ¼ã€‚</p>
      </div>

      <div class="insight-cards">
        <div class="insight-card">
          <div class="insight-label">Total entries</div>
          <div class="insight-value" id="statTotalPosts">0</div>
        </div>
        <div class="insight-card">
          <div class="insight-label">Favorites</div>
          <div class="insight-value" id="statFavorites">0</div>
        </div>
        <div class="insight-card">
          <div class="insight-label">Comments</div>
          <div class="insight-value" id="statComments">0</div>
        </div>
      </div>

      <div id="knowledgeGrid" class="knowledge-grid">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </main>
  </div>
  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">ãƒŠãƒ¬ãƒƒã‚¸è©³ç´°</h2>
        <button class="close-button" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody">
        <!-- è©³ç´°å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </div>
    </div>
  </div>

  <!-- è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ </h2>
        <button class="close-button" onclick="closeAddModal()">&times;</button>
      </div>
      <div id="addModalBody" style="padding: 20px 0;">
        <form id="addKnowledgeForm" onsubmit="submitKnowledge(event)">
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚¿ã‚¤ãƒˆãƒ« *</label>
            <input type="text" id="addTitle" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">URL *</label>
            <input type="url" id="addUrl" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èª¬æ˜ï¼ˆMarkdownå½¢å¼å¯¾å¿œï¼‰</label>
            <textarea id="addComment" rows="6"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; font-family: inherit;"
              placeholder="Markdownå½¢å¼ã§è¨˜è¿°ã§ãã¾ã™"></textarea>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input type="text" id="addTags"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
              placeholder="ä¾‹: TypeScript,GAS,é–‹ç™º">
            <small style="color: #666; font-size: 14px;">è¤‡æ•°ã®ã‚¿ã‚°ã¯ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦ãã ã•ã„</small>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æŠ•ç¨¿è€… *</label>
            <input type="text" id="addPostedBy" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚µãƒ ãƒã‚¤ãƒ«URL</label>
            <input type="url" id="addThumbnailUrl"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
              placeholder="https://example.com/image.jpg">
          </div>

          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
            <button type="button" onclick="closeAddModal()"
              style="padding: 10px 20px; background: #f5f5f5; color: #333; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button type="submit"
              style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
              è¿½åŠ 
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ãƒŠãƒ¬ãƒƒã‚¸ã‚’ç·¨é›†</h2>
        <button class="close-button" onclick="closeEditModal()">&times;</button>
      </div>
      <div id="editModalBody" style="padding: 20px 0;">
        <form id="editKnowledgeForm" onsubmit="submitUpdate(event)">
          <input type="hidden" id="editKnowledgeId">

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚¿ã‚¤ãƒˆãƒ« *</label>
            <input type="text" id="editTitle" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">URL *</label>
            <input type="url" id="editUrl" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èª¬æ˜ï¼ˆMarkdownå½¢å¼å¯¾å¿œï¼‰</label>
            <textarea id="editComment" rows="6"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; font-family: inherit;"
              placeholder="Markdownå½¢å¼ã§è¨˜è¿°ã§ãã¾ã™"></textarea>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input type="text" id="editTags"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
              placeholder="ä¾‹: TypeScript,GAS,é–‹ç™º">
            <small style="color: #666; font-size: 14px;">è¤‡æ•°ã®ã‚¿ã‚°ã¯ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦ãã ã•ã„</small>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æŠ•ç¨¿è€… *</label>
            <input type="text" id="editPostedBy" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚µãƒ ãƒã‚¤ãƒ«URL</label>
            <input type="url" id="editThumbnailUrl"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
              placeholder="https://example.com/image.jpg">
          </div>

          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
            <button type="button" onclick="closeEditModal()"
              style="padding: 10px 20px; background: #f5f5f5; color: #333; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button type="submit"
              style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
              æ›´æ–°
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const CATEGORY_CONFIG = [
      { id: 'all', label: 'ã™ã¹ã¦', icon: 'ğŸŒ' },
      { id: 'article', label: 'æ°—ã«ãªã‚‹è¨˜äº‹', icon: 'ğŸ“°' },
      { id: 'question', label: 'ç›¸è«‡ãƒ»è³ªå•', icon: 'â“' },
      { id: 'recruitment', label: 'ä»²é–“å‹Ÿé›†', icon: 'ğŸ¤' },
      { id: 'showcase', label: 'æˆæœç‰©ç´¹ä»‹', icon: 'ğŸ' },
    ];

    let allKnowledge = [];
    let selectedTags = [];
    let selectedCategory = 'all';
    let currentView = 'all';

    const CLIENT_ID_STORAGE_KEY = 'ai-knowledge-dashboard-client-id';
    function ensureClientId() {
      try {
        let clientId = localStorage.getItem(CLIENT_ID_STORAGE_KEY);
        if (!clientId) {
          clientId = `client-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
          localStorage.setItem(CLIENT_ID_STORAGE_KEY, clientId);
        }
        return clientId;
      } catch (error) {
        console.warn('Failed to access localStorage for client ID:', error);
        return `client-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
      }
    }
    const CLIENT_ID = ensureClientId();
    const LIKED_STORAGE_KEY = 'ai-knowledge-dashboard-liked-ids';
    let likedKnowledgeIds = loadLikedKnowledgeIds();

    function loadLikedKnowledgeIds() {
      try {
        const stored = localStorage.getItem(LIKED_STORAGE_KEY);
        if (!stored) {
          return new Set();
        }
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) {
          return new Set(parsed.map(id => id.toString()));
        }
      } catch (error) {
        console.warn('Failed to load liked IDs from storage:', error);
      }
      return new Set();
    }

    function saveLikedKnowledgeIds() {
      try {
        localStorage.setItem(LIKED_STORAGE_KEY, JSON.stringify(Array.from(likedKnowledgeIds)));
      } catch (error) {
        console.warn('Failed to save liked IDs:', error);
      }
    }

    function isKnowledgeLiked(id) {
      if (!id) {
        return false;
      }
      return likedKnowledgeIds.has(id.toString());
    }

    function markKnowledgeLiked(id) {
      if (!id) {
        return;
      }
      likedKnowledgeIds.add(id.toString());
      saveLikedKnowledgeIds();
      updateInsights();
    }

    function findKnowledgeById(id) {
      return allKnowledge.find(k => k.id == id);
    }

    function renderCommentItem(comment) {
      if (!comment) {
        return '';
      }
      const date = comment.postedAt
        ? (typeof comment.postedAt === 'string'
          ? new Date(comment.postedAt)
          : new Date(comment.postedAt))
        : new Date();
      const statusLabel = comment.pending
        ? '<span style="margin-left: 8px; color: #999; font-size: 0.9em;">é€ä¿¡ä¸­...</span>'
        : '';
      const tempAttr = comment.tempId ? `data-temp-id="${comment.tempId}"` : '';
      return `
        <div class="comment-item ${comment.pending ? 'comment-pending' : ''}" ${tempAttr}
          style="padding: 10px; margin: 10px 0; background: #f5f5f5; border-radius: 5px; opacity: ${comment.pending ? '0.6' : '1'};">
          <strong>${comment.author || 'åŒ¿å'}</strong> - ${date.toLocaleString('ja-JP')} ${statusLabel}
          <div class="markdown-content" style="margin-top: 10px;">${renderMarkdown(comment.text || '')}</div>
        </div>
      `;
    }

    function renderCommentsHtml(comments) {
      if (!comments || comments.length === 0) {
        return '<p>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
      }
      return comments.map(comment => renderCommentItem(comment)).join('');
    }

    function getCategoryInfo(categoryId) {
      const normalized = categoryId || 'article';
      return CATEGORY_CONFIG.find(cat => cat.id === normalized) || CATEGORY_CONFIG.find(cat => cat.id === 'article');
    }

    function updateCategoryUI() {
      document.querySelectorAll('.category-chip').forEach(chip => {
        const cat = chip.getAttribute('data-category');
        if (cat) {
          chip.classList.toggle('active', cat === selectedCategory);
        }
      });
    }

    function setCategory(category) {
      selectedCategory = category;
      updateCategoryUI();
      filterKnowledge();
    }

    function updateViewUI() {
      document.querySelectorAll('.nav-item').forEach(item => {
        const view = item.getAttribute('data-view');
        if (view) {
          item.classList.toggle('active', view === currentView);
        }
      });
    }

    function setView(view) {
      currentView = view;
      updateViewUI();
      filterKnowledge();
    }

    function refreshCommentsUI(knowledgeId) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge) {
        return;
      }
      const commentsList = document.getElementById('commentsList');
      if (!commentsList) {
        return;
      }
      const comments = Array.isArray(knowledge.comments) ? knowledge.comments : [];
      commentsList.innerHTML = renderCommentsHtml(comments);
    }

    function addOptimisticComment(knowledgeId, comment) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge) {
        return;
      }
      if (!Array.isArray(knowledge.comments)) {
        knowledge.comments = [];
      }
      knowledge.comments.push(comment);
      refreshCommentsUI(knowledgeId);
      updateInsights();
    }

    function removeOptimisticComment(knowledgeId, tempId) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge || !Array.isArray(knowledge.comments)) {
        return;
      }
      knowledge.comments = knowledge.comments.filter(comment => comment.tempId !== tempId);
      refreshCommentsUI(knowledgeId);
      updateInsights();
    }

    function confirmOptimisticComment(knowledgeId, tempId) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge || !Array.isArray(knowledge.comments)) {
        return;
      }
      const comment = knowledge.comments.find(c => c.tempId === tempId);
      if (!comment) {
        return;
      }
      comment.pending = false;
      delete comment.tempId;
      comment.postedAt = new Date();
      refreshCommentsUI(knowledgeId);
      updateInsights();
    }

    function updateLikeDisplay(knowledgeId, likes, pending = false) {
      const liked = isKnowledgeLiked(knowledgeId);
      const cardBtn = document.getElementById(`like-btn-${knowledgeId}`);
      if (cardBtn) {
        cardBtn.textContent = liked ? `â¤ï¸ æ¸ˆ ${likes}` : `â¤ï¸ ${likes}`;
        cardBtn.classList.toggle('liked', liked);
        cardBtn.disabled = liked || pending;
        cardBtn.style.opacity = pending ? '0.6' : '1';
      }

      const modalBtn = document.getElementById(`modal-like-btn-${knowledgeId}`);
      if (modalBtn) {
        modalBtn.textContent = liked ? `â¤ï¸ ã„ã„ã­æ¸ˆ ${likes}` : `â¤ï¸ ã„ã„ã­ ${likes}`;
        modalBtn.classList.toggle('liked', liked);
        modalBtn.disabled = liked || pending;
        modalBtn.style.opacity = pending ? '0.6' : '1';
      }
    }

    // IDã®æ­£è¦åŒ–ï¼ˆæ•°å€¤ã®ã¿ã‚’æœ‰åŠ¹ã¨ã™ã‚‹ï¼‰
    function normalizeKnowledgeId(rawId) {
      if (rawId === null || rawId === undefined) {
        return null;
      }

      if (typeof rawId === 'number') {
        return Number.isFinite(rawId) && rawId > 0 ? Math.floor(rawId) : null;
      }

      if (typeof rawId === 'string') {
        const trimmed = rawId.trim();
        if (trimmed === '') {
          return null;
        }
        const parsed = parseInt(trimmed, 10);
        return Number.isNaN(parsed) || parsed <= 0 ? null : parsed;
      }

      return null;
    }

    // Markdownã‚’HTMLã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function renderMarkdown(markdown) {
      if (!markdown || typeof markdown !== 'string') {
        return '';
      }

      try {
        // marked.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (typeof marked !== 'undefined') {
          // XSSå¯¾ç­–: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
          marked.setOptions({
            breaks: true, // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
            gfm: true, // GitHub Flavored Markdownã‚’æœ‰åŠ¹åŒ–
          });
          return marked.parse(markdown);
        } else {
          // marked.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
          return markdown.replace(/\n/g, '<br>');
        }
      } catch (error) {
        console.error('Error rendering markdown:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
        return markdown.replace(/\n/g, '<br>');
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã‚’å–å¾—
    window.onload = function () {
      updateCategoryUI();
      updateViewUI();
      updateInsights();
      // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã®IDãƒã‚§ãƒƒã‚¯
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸIDã®ã¿ã‚’ä¿¡é ¼ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®URLè§£æã¯è¡Œã‚ãªã„
      // (GASã®iframe URLã«ã¯äºˆæœŸã›ã¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚)
      let initialId = normalizeKnowledgeId(SERVER_DATA.initialId);
      if (initialId === null) {
        console.log('No valid initialId provided by server.');
      } else {
        console.log('Parsed initialId from server:', initialId);
      }

      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸåˆæœŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
      const initialData = SERVER_DATA.initialData;
      if (initialData) {
        try {
          console.log('Loaded initial data from server');
          displayKnowledge(initialData);

          // åˆæœŸIDãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã‚’è¡¨ç¤º
          if (initialId !== null) {
            console.log('Attempting to show initial detail for ID:', initialId);
            // å°‘ã—é…å»¶ã•ã›ã¦ãƒ‡ãƒ¼ã‚¿æç”»ã‚’ç¢ºå®Ÿã«ã™ã‚‹
            setTimeout(() => {
              showDetail(initialId, false);
            }, 100);
          }
        } catch (e) {
          console.error('Failed to process initial data:', e);
          loadKnowledge(initialId); // å¤±æ•—æ™‚ã¯é€šå¸¸é€šã‚Šå–å¾—
        }
      } else {
        loadKnowledge(initialId);
      }

      // ... (popstateã‚¤ãƒ™ãƒ³ãƒˆã¯ãã®ã¾ã¾)
    };

    // ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    function loadKnowledge(openId = null) {
      console.log('Loading knowledge list...');
      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Success handler called with result:', result);
          console.log('Result type:', typeof result);

          // JSONæ–‡å­—åˆ—ã¨ã—ã¦è¿”ã£ã¦ãã‚‹å ´åˆã®å‡¦ç†
          let knowledgeList;
          if (typeof result === 'string') {
            try {
              knowledgeList = JSON.parse(result);
              console.log('Parsed knowledge list:', knowledgeList);
            } catch (e) {
              console.error('Failed to parse JSON:', e);
              showError('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
              return;
            }
          } else if (Array.isArray(result)) {
            knowledgeList = result;
          } else if (result === null || result === undefined) {
            console.error('Result is null or undefined');
            showError('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆnullãŒè¿”ã•ã‚Œã¾ã—ãŸï¼‰');
            return;
          } else {
            console.error('Unexpected result type:', typeof result, result);
            showError('äºˆæœŸã—ãªã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
            return;
          }

          displayKnowledge(knowledgeList);

          const normalizedOpenId = normalizeKnowledgeId(openId);
          if (normalizedOpenId !== null) {
            showDetail(normalizedOpenId, false);
          }
        })
        .withFailureHandler(function (error) {
          console.error('Failure handler called with error:', error);
          showError(error);
        })
        .getKnowledgeList();
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
    function displayKnowledge(knowledgeList) {
      const grid = document.getElementById('knowledgeGrid');

      // nullãƒã‚§ãƒƒã‚¯
      if (!knowledgeList) {
        grid.innerHTML = '<div class="error">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        console.error('knowledgeList is null or undefined');
        return;
      }

      // é…åˆ—ã§ãªã„å ´åˆã®å‡¦ç†
      if (!Array.isArray(knowledgeList)) {
        grid.innerHTML = '<div class="error">ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>';
        console.error('knowledgeList is not an array:', knowledgeList);
        return;
      }

      allKnowledge = knowledgeList.map(k => ({
        ...k,
        category: k.category || 'article',
        status: k.status || 'open',
        likePending: false,
        postedAt: k.postedAt ? new Date(k.postedAt) : new Date(),
        comments: Array.isArray(k.comments)
          ? k.comments.map(comment => ({
            ...comment,
            postedAt: comment.postedAt ? new Date(comment.postedAt) : new Date(),
          }))
          : [],
      }));

      if (allKnowledge.length === 0) {
        updateTagFilter([]);
        updateInsights();
        renderKnowledgeGrid([]);
        updateCategoryUI();
        updateViewUI();
        return;
      }

      // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
      updateTagFilter(allKnowledge);
      updateInsights();
      updateCategoryUI();
      updateViewUI();
      filterKnowledge();
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createKnowledgeCard(knowledge) {
      if (!knowledge) {
        return '';
      }

      const categoryInfo = getCategoryInfo(knowledge.category);
      const categoryLabel = categoryInfo ? `${categoryInfo.icon} ${categoryInfo.label}` : 'ãƒŠãƒ¬ãƒƒã‚¸';
      const statusLabel = (knowledge.status || 'open').toUpperCase();
      const date = knowledge.postedAt instanceof Date ? knowledge.postedAt : new Date(knowledge.postedAt || Date.now());
      const dateStr = date.toLocaleDateString('ja-JP');
      const tags = knowledge.tags || [];
      const tagsHtml = tags.map(tag =>
        `<span class="card-tag">${tag}</span>`
      ).join('');
      const descriptionSource = (knowledge.comment || '')
        .replace(/<[^>]+>/g, '')
        .replace(/\n+/g, ' ')
        .trim();
      const description = descriptionSource.length > 0
        ? (descriptionSource.length > 120 ? `${descriptionSource.slice(0, 120)}â€¦` : descriptionSource)
        : 'ï¼ˆèª¬æ˜ãªã—ï¼‰';

      const liked = knowledge.id ? isKnowledgeLiked(knowledge.id) : false;
      const likeButtonClass = `like-button ${liked ? 'liked' : ''}`;
      const likeButtonText = liked ? `â¤ï¸ æ¸ˆ ${knowledge.likes || 0}` : `â¤ï¸ ${knowledge.likes || 0}`;
      const likeButtonDisabled = liked ? 'disabled' : '';

      const coverHtml = knowledge.thumbnailUrl
        ? `<div class="card-cover" style="background-image:url('${knowledge.thumbnailUrl}')"></div>`
        : '';

      return `
        <div class="knowledge-card" onclick="showDetail(${knowledge.id || 0})">
          ${coverHtml}
          <div class="card-header-line">
            <span class="category-badge">${categoryLabel}</span>
            <span class="status-pill">${statusLabel}</span>
          </div>
          <div class="card-title">${knowledge.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</div>
          <div class="card-description">${description}</div>
          <div class="card-tags">${tagsHtml}</div>
          <div class="card-meta">
            <span>${knowledge.postedBy || 'ä¸æ˜'}ãƒ»${dateStr}</span>
            <button id="like-btn-${knowledge.id}" class="${likeButtonClass}" data-knowledge-id="${knowledge.id}"
              onclick="event.stopPropagation(); addLike(${knowledge.id || 0})" ${likeButtonDisabled}>
              ${likeButtonText}
            </button>
          </div>
        </div>
      `;
    }

    // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
    function updateTagFilter(knowledgeList) {
      if (!knowledgeList || !Array.isArray(knowledgeList)) {
        return;
      }

      const tagsSet = new Set();
      knowledgeList.forEach(k => {
        if (k && k.tags && Array.isArray(k.tags)) {
          k.tags.forEach(tag => {
            if (tag) {
              tagsSet.add(tag);
            }
          });
        }
      });

      const tagsFilter = document.getElementById('tagsFilter');
      if (!tagsFilter) {
        return;
      }

      tagsFilter.innerHTML = Array.from(tagsSet).map(tag =>
        `<span class="tag-chip ${selectedTags.includes(tag) ? 'active' : ''}" onclick="toggleTag('${tag}')">${tag}</span>`
      ).join('');
    }

    // ã‚¿ã‚°ã‚’ãƒˆã‚°ãƒ«
    function toggleTag(tag) {
      const index = selectedTags.indexOf(tag);
      if (index > -1) {
        selectedTags.splice(index, 1);
      } else {
        selectedTags.push(tag);
      }
      filterKnowledge();
    }

    function renderKnowledgeGrid(list) {
      const grid = document.getElementById('knowledgeGrid');
      if (!grid) {
        return;
      }
      if (!list || list.length === 0) {
        grid.innerHTML = '<div class="loading">è¡¨ç¤ºã§ãã‚‹ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }
      grid.innerHTML = list.map(k => createKnowledgeCard(k)).join('');
    }

    function updateInsights() {
      const totalEl = document.getElementById('statTotalPosts');
      if (totalEl) {
        totalEl.textContent = allKnowledge.length.toString();
      }
      const favoriteEl = document.getElementById('statFavorites');
      if (favoriteEl) {
        favoriteEl.textContent = likedKnowledgeIds.size.toString();
      }
      const commentCount = allKnowledge.reduce((sum, item) => {
        return sum + (item.comments ? item.comments.length : 0);
      }, 0);
      const commentsEl = document.getElementById('statComments');
      if (commentsEl) {
        commentsEl.textContent = commentCount.toString();
      }
    }

    // æ¤œç´¢
    function searchKnowledge() {
      filterKnowledge();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterKnowledge() {
      const searchInput = document.getElementById('searchInput');
      const searchWord = searchInput ? searchInput.value.toLowerCase() : '';

      // ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ
      const filteredList = allKnowledge.filter(k => {
        const normalizedCategory = k.category || 'article';
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
        let matchesSearch = true;
        if (searchWord) {
          matchesSearch =
            (k.title && k.title.toLowerCase().includes(searchWord)) ||
            (k.comment && k.comment.toLowerCase().includes(searchWord)) ||
            (k.url && k.url.toLowerCase().includes(searchWord));
        }

        // ã‚¿ã‚°æ¤œç´¢
        let matchesTags = true;
        if (selectedTags.length > 0) {
          matchesTags = selectedTags.some(tag => k.tags && k.tags.includes(tag));
        }

        const matchesCategory = selectedCategory === 'all' || normalizedCategory === selectedCategory;
        const matchesView = currentView === 'all' ? true : isKnowledgeLiked(k.id);

        return matchesSearch && matchesTags && matchesCategory && matchesView;
      });

      renderKnowledgeGrid(filteredList);

      // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã®è¡¨ç¤ºã‚’æ›´æ–°
      document.querySelectorAll('.tag-chip').forEach(chip => {
        const tag = chip.textContent;
        if (selectedTags.includes(tag)) {
          chip.classList.add('active');
        } else {
          chip.classList.remove('active');
        }
      });
    }

    // è©³ç´°ã‚’è¡¨ç¤º
    function showDetail(id, updateHistory = true) {
      const normalizedId = normalizeKnowledgeId(id);
      if (normalizedId === null) {
        console.warn('showDetail was called with an invalid ID:', id);
        return;
      }

      // URLæ›´æ–°
      if (updateHistory) {
        // GASã®exec URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å½¢å¼ã«åˆã‚ã›ã‚‹
        // ç¾åœ¨ã®URLã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ /ç½®æ›
        const url = new URL(window.location.href);
        url.searchParams.set('id', normalizedId.toString());
        // pushStateã§å±¥æ­´ã«è¿½åŠ 
        if (url.href !== window.location.href) {
          window.history.pushState({ id: normalizedId }, '', url.search);
        }
      }

      // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸€è¦§å–å¾—æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã‹ã‚‰æ¢ã™
      // å‹å¤‰æ›ã—ã¦æ¯”è¼ƒ (==) ã‚’ä½¿ç”¨ã—ã¦æŸ”è»Ÿã«ãƒãƒƒãƒã•ã›ã‚‹
      console.log('Searching knowledge with id:', normalizedId);
      const knowledge = allKnowledge.find(k => k.id == normalizedId);

      if (knowledge) {
        console.log('Displaying detail from local data:', knowledge.title);
        displayDetail(knowledge);
      } else {
        console.log('Knowledge not found in local data, fetching from server...');
        google.script.run
          .withSuccessHandler(function (result) {
            // JSONæ–‡å­—åˆ—ã¨ã—ã¦è¿”ã£ã¦ãã‚‹å ´åˆã®å‡¦ç†
            let knowledge;
            if (typeof result === 'string') {
              try {
                knowledge = JSON.parse(result);
              } catch (e) {
                console.error('Failed to parse JSON:', e);
                alert('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
              }
            } else {
              knowledge = result;
            }
            displayDetail(knowledge);
          })
          .withFailureHandler(function (error) {
            console.error('Failed to fetch detail:', error);
            alert('è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ID: ' + normalizedId);
          })
          .getKnowledgeDetail(normalizedId);
      }
    }

    // è©³ç´°ã‚’è¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
    function displayDetail(knowledge) {
      if (!knowledge || knowledge === null) {
        showError('ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }

      const localIndex = allKnowledge.findIndex(k => k.id == knowledge.id);
      if (localIndex === -1) {
        allKnowledge.push(knowledge);
      } else {
        allKnowledge[localIndex] = knowledge;
      }

      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = knowledge.title;

      // postedAtãŒæ–‡å­—åˆ—ã®å ´åˆã‚‚Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
      const date = knowledge.postedAt
        ? (typeof knowledge.postedAt === 'string'
          ? new Date(knowledge.postedAt)
          : new Date(knowledge.postedAt))
        : new Date();
      const dateStr = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP');

      const categoryInfo = getCategoryInfo(knowledge.category);
      const categoryLabel = categoryInfo ? `${categoryInfo.icon} ${categoryInfo.label}` : 'ãƒŠãƒ¬ãƒƒã‚¸';
      const statusLabel = (knowledge.status || 'open').toUpperCase();

      const tagsHtml = (knowledge.tags || []).map(tag =>
        `<span class="card-tag">${tag}</span>`
      ).join('');

      const commentsArray = Array.isArray(knowledge.comments) ? knowledge.comments : [];
      const commentsHtml = renderCommentsHtml(commentsArray);
      const isLiked = knowledge.id ? isKnowledgeLiked(knowledge.id) : false;
      const likesCount = knowledge.likes || 0;
      const modalLikeLabel = isLiked ? `â¤ï¸ ã„ã„ã­æ¸ˆ ${likesCount}` : `â¤ï¸ ã„ã„ã­ ${likesCount}`;
      const modalLikeClass = `like-button ${isLiked ? 'liked' : ''}`;
      const modalLikeDisabled = isLiked ? 'disabled' : '';

      const knowledgeUrl = knowledge.url || '';
      const urlMarkup = knowledgeUrl
        ? `<a href="${knowledgeUrl}" target="_blank">${knowledgeUrl}</a>`
        : 'URLã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';

      modalBody.innerHTML = `
        <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px;">
          <span class="category-badge">${categoryLabel}</span>
          <span class="status-pill">${statusLabel}</span>
        </div>
        ${knowledge.thumbnailUrl ? `<img src="${knowledge.thumbnailUrl}" alt="${knowledge.title}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 5px; margin-bottom: 20px;">` : ''}
        <p><strong>URL:</strong> ${urlMarkup}</p>
        <p><strong>æŠ•ç¨¿è€…:</strong> ${knowledge.postedBy}</p>
        <p><strong>æŠ•ç¨¿æ—¥æ™‚:</strong> ${dateStr}</p>
        <div class="card-tags" style="margin: 15px 0;">${tagsHtml}</div>
        <p><strong>èª¬æ˜:</strong></p>
        <div class="markdown-content">${renderMarkdown(knowledge.comment || 'ï¼ˆèª¬æ˜ãªã—ï¼‰')}</div>
        <div style="margin: 20px 0;">
          <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
          <div id="commentsList">${commentsHtml}</div>
          <div style="margin-top: 20px;">
            <input type="text" id="newComment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." style="width: 70%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            <input type="text" id="commentAuthor" placeholder="ãŠåå‰" style="width: 20%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-left: 10px;">
            <button onclick="submitComment(${knowledge.id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">æŠ•ç¨¿</button>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button id="modal-like-btn-${knowledge.id}" class="${modalLikeClass}" onclick="addLike(${knowledge.id})" style="flex: 1;" ${modalLikeDisabled}>
            ${modalLikeLabel}
          </button>
          <button onclick="copyShareLink(${knowledge.id})" style="padding: 10px 20px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 16px;">
             ğŸ”— ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
          </button>
          <button onclick="openEditModal(${knowledge.id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ç·¨é›†
          </button>
        </div>
      `;

      modal.classList.add('active');
      updateLikeDisplay(knowledge.id, knowledge.likes, knowledge.likePending);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
      // URLã‚’æˆ»ã™
      const url = new URL(window.location.href);
      if (url.searchParams.has('id')) {
        url.searchParams.delete('id');
        // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ ? ã‚‚æ¶ˆã—ãŸã„ãŒã€GASã®URLæ§‹é€ ä¸Š search ã ã‘ç½®æ›ã§OKã‹ç¢ºèª
        // pushStateã®ç¬¬ä¸‰å¼•æ•°ã¯ãƒ‘ã‚¹ã¾ãŸã¯ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—
        window.history.pushState({ id: null }, '', url.pathname + url.search);
      }
      document.getElementById('detailModal').classList.remove('active');
    }

    // å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
    function copyShareLink(id) {
      const normalizedId = normalizeKnowledgeId(id);
      if (normalizedId === null) {
        alert('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆIDãŒä¸æ­£ã§ã™ï¼‰');
        return;
      }

      const baseUrl = SERVER_DATA.appUrl || window.location.href.split('?')[0];
      const shareUrl = `${baseUrl}?id=${normalizedId}`;

      navigator.clipboard.writeText(shareUrl).then(() => {
        alert('å…±æœ‰ç”¨URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n' + shareUrl);
      }).catch(err => {
        console.error('Failed to copy:', err);
        prompt('ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', shareUrl);
      });
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
    function submitComment(knowledgeId) {
      const commentText = document.getElementById('newComment').value;
      const author = document.getElementById('commentAuthor').value || 'åŒ¿å';

      if (!commentText.trim()) {
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const tempId = `temp-${knowledgeId}-${Date.now()}`;
      const optimisticComment = {
        tempId,
        text: commentText,
        author,
        postedAt: new Date(),
        pending: true,
      };

      document.getElementById('newComment').value = '';
      document.getElementById('commentAuthor').value = '';
      addOptimisticComment(knowledgeId, optimisticComment);

      google.script.run
        .withSuccessHandler(function (success) {
          if (success) {
            confirmOptimisticComment(knowledgeId, tempId);
            loadKnowledge(knowledgeId);
          } else {
            removeOptimisticComment(knowledgeId, tempId);
            showError('ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function (error) {
          removeOptimisticComment(knowledgeId, tempId);
          showError(error);
        })
        .addComment(knowledgeId, commentText, author);
    }

    // ã„ã„ã­ã‚’è¿½åŠ 
    function addLike(knowledgeId) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge) {
        showError('ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }
      if (isKnowledgeLiked(knowledgeId)) {
        return;
      }

      if (knowledge.likePending) {
        return;
      }

      const originalLikes = knowledge.likes || 0;
      knowledge.likePending = true;
      knowledge.likes = originalLikes + 1;
      updateLikeDisplay(knowledgeId, knowledge.likes, true);

      google.script.run
        .withSuccessHandler(function (newLikes) {
          knowledge.likes = newLikes;
          knowledge.likePending = false;
          markKnowledgeLiked(knowledgeId);
          updateLikeDisplay(knowledgeId, newLikes, false);
        })
        .withFailureHandler(function (error) {
          console.error('Error adding like:', error);
          knowledge.likes = originalLikes;
          knowledge.likePending = false;
          updateLikeDisplay(knowledgeId, originalLikes, false);
          showError('ã„ã„ã­ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .addLike(knowledgeId, CLIENT_ID);
    }

    // ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    function showError(error) {
      console.error('showError called with:', error);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›
      const errorMessage = error?.message || error?.toString() || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';

      // æ—¢å­˜ã®ä¸€è¦§ã‚’æ¶ˆã•ãšã«ã€ãƒˆãƒ¼ã‚¹ãƒˆã¾ãŸã¯ã‚¢ãƒ©ãƒ¼ãƒˆã§é€šçŸ¥
      // ã‚‚ã—è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã“ã†ã¨ã—ã¦ã„ãŸãªã‚‰ã€ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ã‹é–‰ã˜ã‚‹
      alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${errorMessage}`);

      // ã‚‚ã—ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºä¸­ãªã‚‰æ¶ˆã™
      const grid = document.getElementById('knowledgeGrid');
      if (grid && grid.innerHTML.includes('class="loading"')) {
        // ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒä½•ã‚‚ãªã„ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ï¼‰å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ã¦ã‚‚è‰¯ã„
        grid.innerHTML = `<div class="error">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}</div>`;
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.onclick = function (event) {
      const detailModal = document.getElementById('detailModal');
      const addModal = document.getElementById('addModal');
      const editModal = document.getElementById('editModal');
      if (event.target === detailModal) {
        closeModal();
      }
      if (event.target === addModal) {
        closeAddModal();
      }
      if (event.target === editModal) {
        closeEditModal();
      }
    }

    // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openAddModal() {
      document.getElementById('addModal').classList.add('active');
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('addKnowledgeForm').reset();
    }

    // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeAddModal() {
      document.getElementById('addModal').classList.remove('active');
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ 
    function submitKnowledge(event) {
      event.preventDefault();

      const knowledge = {
        title: document.getElementById('addTitle').value.trim(),
        url: document.getElementById('addUrl').value.trim(),
        comment: document.getElementById('addComment').value.trim(),
        tags: document.getElementById('addTags').value.trim(),
        postedBy: document.getElementById('addPostedBy').value.trim(),
        thumbnailUrl: document.getElementById('addThumbnailUrl').value.trim(),
      };

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!knowledge.title || !knowledge.url || !knowledge.postedBy) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã€URLã€æŠ•ç¨¿è€…ã¯å¿…é ˆé …ç›®ã§ã™');
        return;
      }

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const submitButton = event.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'è¿½åŠ ä¸­...';

      google.script.run
        .withSuccessHandler(function (result) {
          try {
            const response = typeof result === 'string' ? JSON.parse(result) : result;
            if (response.success) {
              closeAddModal();
              loadKnowledge(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
              alert('ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
            } else {
              alert('ã‚¨ãƒ©ãƒ¼: ' + (response.error || 'ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .withFailureHandler(function (error) {
          console.error('Error adding knowledge:', error);
          alert('ã‚¨ãƒ©ãƒ¼: ' + (error?.message || 'ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .addKnowledge(knowledge);
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openEditModal(knowledgeId) {
      // ã¾ãšè©³ç´°ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function (result) {
          let knowledge;
          if (typeof result === 'string') {
            try {
              knowledge = JSON.parse(result);
            } catch (e) {
              console.error('Failed to parse JSON:', e);
              showError('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
              return;
            }
          } else {
            knowledge = result;
          }

          if (!knowledge || knowledge === null) {
            alert('ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            return;
          }

          // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
          document.getElementById('editKnowledgeId').value = knowledgeId;
          document.getElementById('editTitle').value = knowledge.title || '';
          document.getElementById('editUrl').value = knowledge.url || '';
          document.getElementById('editComment').value = knowledge.comment || '';
          document.getElementById('editTags').value = (knowledge.tags || []).join(',');
          document.getElementById('editPostedBy').value = knowledge.postedBy || '';
          document.getElementById('editThumbnailUrl').value = knowledge.thumbnailUrl || '';

          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
          document.getElementById('editModal').classList.add('active');
        })
        .withFailureHandler(function (error) {
          console.error('Error loading knowledge for edit:', error);
          alert('ãƒŠãƒ¬ãƒƒã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getKnowledgeDetail(knowledgeId);
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ›´æ–°
    function submitUpdate(event) {
      event.preventDefault();

      const knowledgeId = parseInt(document.getElementById('editKnowledgeId').value);
      const knowledge = {
        title: document.getElementById('editTitle').value.trim(),
        url: document.getElementById('editUrl').value.trim(),
        comment: document.getElementById('editComment').value.trim(),
        tags: document.getElementById('editTags').value.trim(),
        postedBy: document.getElementById('editPostedBy').value.trim(),
        thumbnailUrl: document.getElementById('editThumbnailUrl').value.trim(),
      };

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!knowledge.title || !knowledge.url || !knowledge.postedBy) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã€URLã€æŠ•ç¨¿è€…ã¯å¿…é ˆé …ç›®ã§ã™');
        return;
      }

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const submitButton = event.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'æ›´æ–°ä¸­...';

      google.script.run
        .withSuccessHandler(function (result) {
          try {
            const response = typeof result === 'string' ? JSON.parse(result) : result;
            if (response.success) {
              closeEditModal();
              closeModal(); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚é–‰ã˜ã‚‹
              loadKnowledge(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
              alert('ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
            } else {
              alert('ã‚¨ãƒ©ãƒ¼: ' + (response.error || 'ãƒŠãƒ¬ãƒƒã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('ãƒŠãƒ¬ãƒƒã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .withFailureHandler(function (error) {
          console.error('Error updating knowledge:', error);
          alert('ã‚¨ãƒ©ãƒ¼: ' + (error?.message || 'ãƒŠãƒ¬ãƒƒã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .updateKnowledge(knowledgeId, knowledge);
    }
  </script>
</body>

</html>
