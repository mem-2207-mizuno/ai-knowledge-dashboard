<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Knowledge Dashboard</title>
  <!-- Markdownãƒ‘ãƒ¼ã‚µãƒ¼ -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 0;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .search-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .search-box input {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .search-box input:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-box button {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }

    .search-box button:hover {
      background: #5568d3;
    }

    .tags-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .tag-chip {
      padding: 6px 12px;
      background: #e0e0e0;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .tag-chip:hover {
      background: #667eea;
      color: white;
    }

    .tag-chip.active {
      background: #667eea;
      color: white;
    }

    .knowledge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .knowledge-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }

    .knowledge-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .card-thumbnail {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #f0f0f0;
    }

    .card-content {
      padding: 20px;
    }

    .card-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      font-size: 0.9em;
      color: #666;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .card-tag {
      padding: 4px 8px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 12px;
      font-size: 0.8em;
    }

    .like-button {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      background: #f5f5f5;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .like-button:hover {
      background: #ffebee;
    }

    .like-button.liked {
      background: #ffcdd2;
      color: #c62828;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 10px;
      padding: 30px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      margin: 20px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #333;
    }

    .close-button {
      background: none;
      border: none;
      font-size: 2em;
      cursor: pointer;
      color: #666;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }

    /* Markdownè¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .markdown-content {
      line-height: 1.8;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-weight: bold;
    }

    .markdown-content h1 {
      font-size: 2em;
    }

    .markdown-content h2 {
      font-size: 1.5em;
    }

    .markdown-content h3 {
      font-size: 1.25em;
    }

    .markdown-content p {
      margin: 1em 0;
    }

    .markdown-content ul,
    .markdown-content ol {
      margin: 1em 0;
      padding-left: 2em;
    }

    .markdown-content li {
      margin: 0.5em 0;
    }

    .markdown-content code {
      background-color: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .markdown-content pre {
      background-color: #f4f4f4;
      padding: 1em;
      border-radius: 5px;
      overflow-x: auto;
      margin: 1em 0;
    }

    .markdown-content pre code {
      background-color: transparent;
      padding: 0;
    }

    .markdown-content blockquote {
      border-left: 4px solid #667eea;
      padding-left: 1em;
      margin: 1em 0;
      color: #666;
    }

    .markdown-content a {
      color: #667eea;
      text-decoration: none;
    }

    .markdown-content a:hover {
      text-decoration: underline;
    }

    .markdown-content img {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      margin: 1em 0;
    }

    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
    }

    .markdown-content table th,
    .markdown-content table td {
      border: 1px solid #ddd;
      padding: 0.5em;
      text-align: left;
    }

    .markdown-content table th {
      background-color: #f4f4f4;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <!-- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾© -->
  <script>
    const SERVER_DATA = {
      initialData: <?!= initialData ?>,
      initialId: <?= initialId !== null ? initialId : 'null' ?>,
      appUrl: "<?!= appUrl ?>"
    };
  </script>

  <div class="container">
    <header>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>AI Knowledge Dashboard</h1>
        <button onclick="openAddModal()"
          style="padding: 10px 20px; background: white; color: #667eea; border: 2px solid white; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s;">
          + ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ 
        </button>
      </div>
    </header>

    <div class="search-section">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
        <button onclick="searchKnowledge()">æ¤œç´¢</button>
      </div>
      <div class="tags-filter" id="tagsFilter">
        <!-- ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
      </div>
    </div>

    <div id="knowledgeGrid" class="knowledge-grid">
      <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">ãƒŠãƒ¬ãƒƒã‚¸è©³ç´°</h2>
        <button class="close-button" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody">
        <!-- è©³ç´°å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </div>
    </div>
  </div>

  <!-- è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ </h2>
        <button class="close-button" onclick="closeAddModal()">&times;</button>
      </div>
      <div id="addModalBody" style="padding: 20px 0;">
        <form id="addKnowledgeForm" onsubmit="submitKnowledge(event)">
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚¿ã‚¤ãƒˆãƒ« *</label>
            <input type="text" id="addTitle" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">URL *</label>
            <input type="url" id="addUrl" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èª¬æ˜ï¼ˆMarkdownå½¢å¼å¯¾å¿œï¼‰</label>
            <textarea id="addComment" rows="6"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; font-family: inherit;"
              placeholder="Markdownå½¢å¼ã§è¨˜è¿°ã§ãã¾ã™"></textarea>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input type="text" id="addTags"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
              placeholder="ä¾‹: TypeScript,GAS,é–‹ç™º">
            <small style="color: #666; font-size: 14px;">è¤‡æ•°ã®ã‚¿ã‚°ã¯ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦ãã ã•ã„</small>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æŠ•ç¨¿è€… *</label>
            <input type="text" id="addPostedBy" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚µãƒ ãƒã‚¤ãƒ«URL</label>
            <input type="url" id="addThumbnailUrl"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
              placeholder="https://example.com/image.jpg">
          </div>

          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
            <button type="button" onclick="closeAddModal()"
              style="padding: 10px 20px; background: #f5f5f5; color: #333; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button type="submit"
              style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
              è¿½åŠ 
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ãƒŠãƒ¬ãƒƒã‚¸ã‚’ç·¨é›†</h2>
        <button class="close-button" onclick="closeEditModal()">&times;</button>
      </div>
      <div id="editModalBody" style="padding: 20px 0;">
        <form id="editKnowledgeForm" onsubmit="submitUpdate(event)">
          <input type="hidden" id="editKnowledgeId">

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚¿ã‚¤ãƒˆãƒ« *</label>
            <input type="text" id="editTitle" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">URL *</label>
            <input type="url" id="editUrl" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èª¬æ˜ï¼ˆMarkdownå½¢å¼å¯¾å¿œï¼‰</label>
            <textarea id="editComment" rows="6"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; font-family: inherit;"
              placeholder="Markdownå½¢å¼ã§è¨˜è¿°ã§ãã¾ã™"></textarea>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input type="text" id="editTags"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
              placeholder="ä¾‹: TypeScript,GAS,é–‹ç™º">
            <small style="color: #666; font-size: 14px;">è¤‡æ•°ã®ã‚¿ã‚°ã¯ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦ãã ã•ã„</small>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æŠ•ç¨¿è€… *</label>
            <input type="text" id="editPostedBy" required
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚µãƒ ãƒã‚¤ãƒ«URL</label>
            <input type="url" id="editThumbnailUrl"
              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
              placeholder="https://example.com/image.jpg">
          </div>

          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
            <button type="button" onclick="closeEditModal()"
              style="padding: 10px 20px; background: #f5f5f5; color: #333; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button type="submit"
              style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
              æ›´æ–°
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let allKnowledge = [];
    let selectedTags = [];

    // IDã®æ­£è¦åŒ–ï¼ˆæ•°å€¤ã®ã¿ã‚’æœ‰åŠ¹ã¨ã™ã‚‹ï¼‰
    function normalizeKnowledgeId(rawId) {
      if (rawId === null || rawId === undefined) {
        return null;
      }

      if (typeof rawId === 'number') {
        return Number.isFinite(rawId) && rawId > 0 ? Math.floor(rawId) : null;
      }

      if (typeof rawId === 'string') {
        const trimmed = rawId.trim();
        if (trimmed === '') {
          return null;
        }
        const parsed = parseInt(trimmed, 10);
        return Number.isNaN(parsed) || parsed <= 0 ? null : parsed;
      }

      return null;
    }

    // Markdownã‚’HTMLã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function renderMarkdown(markdown) {
      if (!markdown || typeof markdown !== 'string') {
        return '';
      }

      try {
        // marked.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (typeof marked !== 'undefined') {
          // XSSå¯¾ç­–: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
          marked.setOptions({
            breaks: true, // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
            gfm: true, // GitHub Flavored Markdownã‚’æœ‰åŠ¹åŒ–
          });
          return marked.parse(markdown);
        } else {
          // marked.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
          return markdown.replace(/\n/g, '<br>');
        }
      } catch (error) {
        console.error('Error rendering markdown:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
        return markdown.replace(/\n/g, '<br>');
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã‚’å–å¾—
    window.onload = function () {
      // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã®IDãƒã‚§ãƒƒã‚¯
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸIDã®ã¿ã‚’ä¿¡é ¼ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®URLè§£æã¯è¡Œã‚ãªã„
      // (GASã®iframe URLã«ã¯äºˆæœŸã›ã¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚)
      let initialId = normalizeKnowledgeId(SERVER_DATA.initialId);
      if (initialId === null) {
        console.log('No valid initialId provided by server.');
      } else {
        console.log('Parsed initialId from server:', initialId);
      }

      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸåˆæœŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
      const initialData = SERVER_DATA.initialData;
      if (initialData) {
        try {
          console.log('Loaded initial data from server');
          displayKnowledge(initialData);

          // åˆæœŸIDãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã‚’è¡¨ç¤º
          if (initialId !== null) {
            console.log('Attempting to show initial detail for ID:', initialId);
            // å°‘ã—é…å»¶ã•ã›ã¦ãƒ‡ãƒ¼ã‚¿æç”»ã‚’ç¢ºå®Ÿã«ã™ã‚‹
            setTimeout(() => {
              showDetail(initialId, false);
            }, 100);
          }
        } catch (e) {
          console.error('Failed to process initial data:', e);
          loadKnowledge(initialId); // å¤±æ•—æ™‚ã¯é€šå¸¸é€šã‚Šå–å¾—
        }
      } else {
        loadKnowledge(initialId);
      }

      // ... (popstateã‚¤ãƒ™ãƒ³ãƒˆã¯ãã®ã¾ã¾)
    };

    // ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    function loadKnowledge(openId = null) {
      console.log('Loading knowledge list...');
      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Success handler called with result:', result);
          console.log('Result type:', typeof result);

          // JSONæ–‡å­—åˆ—ã¨ã—ã¦è¿”ã£ã¦ãã‚‹å ´åˆã®å‡¦ç†
          let knowledgeList;
          if (typeof result === 'string') {
            try {
              knowledgeList = JSON.parse(result);
              console.log('Parsed knowledge list:', knowledgeList);
            } catch (e) {
              console.error('Failed to parse JSON:', e);
              showError('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
              return;
            }
          } else if (Array.isArray(result)) {
            knowledgeList = result;
          } else if (result === null || result === undefined) {
            console.error('Result is null or undefined');
            showError('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆnullãŒè¿”ã•ã‚Œã¾ã—ãŸï¼‰');
            return;
          } else {
            console.error('Unexpected result type:', typeof result, result);
            showError('äºˆæœŸã—ãªã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
            return;
          }

          displayKnowledge(knowledgeList);

          const normalizedOpenId = normalizeKnowledgeId(openId);
          if (normalizedOpenId !== null) {
            showDetail(normalizedOpenId, false);
          }
        })
        .withFailureHandler(function (error) {
          console.error('Failure handler called with error:', error);
          showError(error);
        })
        .getKnowledgeList();
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
    function displayKnowledge(knowledgeList) {
      const grid = document.getElementById('knowledgeGrid');

      // nullãƒã‚§ãƒƒã‚¯
      if (!knowledgeList) {
        grid.innerHTML = '<div class="error">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        console.error('knowledgeList is null or undefined');
        return;
      }

      // é…åˆ—ã§ãªã„å ´åˆã®å‡¦ç†
      if (!Array.isArray(knowledgeList)) {
        grid.innerHTML = '<div class="error">ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>';
        console.error('knowledgeList is not an array:', knowledgeList);
        return;
      }

      allKnowledge = knowledgeList;

      if (knowledgeList.length === 0) {
        grid.innerHTML = '<div class="loading">ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }

      // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
      updateTagFilter(knowledgeList);

      // ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      grid.innerHTML = knowledgeList.map(k => createKnowledgeCard(k)).join('');
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createKnowledgeCard(knowledge) {
      if (!knowledge) {
        return '';
      }

      // postedAtãŒæ–‡å­—åˆ—ã®å ´åˆã‚‚Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
      const date = knowledge.postedAt
        ? (typeof knowledge.postedAt === 'string'
          ? new Date(knowledge.postedAt)
          : new Date(knowledge.postedAt))
        : new Date();
      const dateStr = date.toLocaleDateString('ja-JP');

      const tags = knowledge.tags || [];
      const tagsHtml = tags.map(tag =>
        `<span class="card-tag">${tag}</span>`
      ).join('');

      return `
        <div class="knowledge-card" onclick="showDetail(${knowledge.id || 0})">
          ${knowledge.thumbnailUrl ?
          `<img src="${knowledge.thumbnailUrl}" alt="${knowledge.title || ''}" class="card-thumbnail" onerror="this.style.display='none'">` :
          '<div class="card-thumbnail" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>'
        }
          <div class="card-content">
            <div class="card-title">${knowledge.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</div>
            <div class="card-tags">${tagsHtml}</div>
            <div class="card-meta">
              <span>${knowledge.postedBy || 'ä¸æ˜'} - ${dateStr}</span>
              <button id="like-btn-${knowledge.id}" class="like-button" onclick="event.stopPropagation(); addLike(${knowledge.id || 0})">
                â¤ï¸ ${knowledge.likes || 0}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
    function updateTagFilter(knowledgeList) {
      if (!knowledgeList || !Array.isArray(knowledgeList)) {
        return;
      }

      const tagsSet = new Set();
      knowledgeList.forEach(k => {
        if (k && k.tags && Array.isArray(k.tags)) {
          k.tags.forEach(tag => {
            if (tag) {
              tagsSet.add(tag);
            }
          });
        }
      });

      const tagsFilter = document.getElementById('tagsFilter');
      if (!tagsFilter) {
        return;
      }

      tagsFilter.innerHTML = Array.from(tagsSet).map(tag =>
        `<span class="tag-chip ${selectedTags.includes(tag) ? 'active' : ''}" onclick="toggleTag('${tag}')">${tag}</span>`
      ).join('');
    }

    // ã‚¿ã‚°ã‚’ãƒˆã‚°ãƒ«
    function toggleTag(tag) {
      const index = selectedTags.indexOf(tag);
      if (index > -1) {
        selectedTags.splice(index, 1);
      } else {
        selectedTags.push(tag);
      }
      filterKnowledge();
    }

    // æ¤œç´¢
    function searchKnowledge() {
      filterKnowledge();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterKnowledge() {
      const searchWord = document.getElementById('searchInput').value.toLowerCase();

      // ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ
      const filteredList = allKnowledge.filter(k => {
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
        let matchesSearch = true;
        if (searchWord) {
          matchesSearch =
            (k.title && k.title.toLowerCase().includes(searchWord)) ||
            (k.comment && k.comment.toLowerCase().includes(searchWord)) ||
            (k.url && k.url.toLowerCase().includes(searchWord));
        }

        // ã‚¿ã‚°æ¤œç´¢
        let matchesTags = true;
        if (selectedTags.length > 0) {
          matchesTags = selectedTags.some(tag => k.tags && k.tags.includes(tag));
        }

        return matchesSearch && matchesTags;
      });

      // çµæœã‚’è¡¨ç¤ºï¼ˆcreateKnowledgeCardã§å†æç”»ï¼‰
      const grid = document.getElementById('knowledgeGrid');
      if (filteredList.length === 0) {
        grid.innerHTML = '<div class="loading">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
      } else {
        grid.innerHTML = filteredList.map(k => createKnowledgeCard(k)).join('');
      }

      // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã®è¡¨ç¤ºã‚’æ›´æ–°
      document.querySelectorAll('.tag-chip').forEach(chip => {
        const tag = chip.textContent;
        if (selectedTags.includes(tag)) {
          chip.classList.add('active');
        } else {
          chip.classList.remove('active');
        }
      });
    }

    // è©³ç´°ã‚’è¡¨ç¤º
    function showDetail(id, updateHistory = true) {
      const normalizedId = normalizeKnowledgeId(id);
      if (normalizedId === null) {
        console.warn('showDetail was called with an invalid ID:', id);
        return;
      }

      // URLæ›´æ–°
      if (updateHistory) {
        // GASã®exec URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å½¢å¼ã«åˆã‚ã›ã‚‹
        // ç¾åœ¨ã®URLã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ /ç½®æ›
        const url = new URL(window.location.href);
        url.searchParams.set('id', normalizedId.toString());
        // pushStateã§å±¥æ­´ã«è¿½åŠ 
        if (url.href !== window.location.href) {
          window.history.pushState({ id: normalizedId }, '', url.search);
        }
      }

      // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸€è¦§å–å¾—æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã‹ã‚‰æ¢ã™
      // å‹å¤‰æ›ã—ã¦æ¯”è¼ƒ (==) ã‚’ä½¿ç”¨ã—ã¦æŸ”è»Ÿã«ãƒãƒƒãƒã•ã›ã‚‹
      console.log('Searching knowledge with id:', normalizedId);
      const knowledge = allKnowledge.find(k => k.id == normalizedId);

      if (knowledge) {
        console.log('Displaying detail from local data:', knowledge.title);
        displayDetail(knowledge);
      } else {
        console.log('Knowledge not found in local data, fetching from server...');
        google.script.run
          .withSuccessHandler(function (result) {
            // JSONæ–‡å­—åˆ—ã¨ã—ã¦è¿”ã£ã¦ãã‚‹å ´åˆã®å‡¦ç†
            let knowledge;
            if (typeof result === 'string') {
              try {
                knowledge = JSON.parse(result);
              } catch (e) {
                console.error('Failed to parse JSON:', e);
                alert('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
              }
            } else {
              knowledge = result;
            }
            displayDetail(knowledge);
          })
          .withFailureHandler(function (error) {
            console.error('Failed to fetch detail:', error);
            alert('è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ID: ' + normalizedId);
          })
          .getKnowledgeDetail(normalizedId);
      }
    }

    // è©³ç´°ã‚’è¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
    function displayDetail(knowledge) {
      if (!knowledge || knowledge === null) {
        showError('ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }

      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = knowledge.title;

      // postedAtãŒæ–‡å­—åˆ—ã®å ´åˆã‚‚Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
      const date = knowledge.postedAt
        ? (typeof knowledge.postedAt === 'string'
          ? new Date(knowledge.postedAt)
          : new Date(knowledge.postedAt))
        : new Date();
      const dateStr = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP');

      const tagsHtml = knowledge.tags.map(tag =>
        `<span class="card-tag">${tag}</span>`
      ).join('');

      const commentsHtml = (knowledge.comments || []).map(comment => {
        // postedAtãŒæ–‡å­—åˆ—ã®å ´åˆã‚‚Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
        const commentDate = comment.postedAt
          ? (typeof comment.postedAt === 'string'
            ? new Date(comment.postedAt)
            : new Date(comment.postedAt))
          : new Date();
        return `
          <div style="padding: 10px; margin: 10px 0; background: #f5f5f5; border-radius: 5px;">
            <strong>${comment.author || 'åŒ¿å'}</strong> - ${commentDate.toLocaleString('ja-JP')}
            <div class="markdown-content" style="margin-top: 10px;">${renderMarkdown(comment.text || '')}</div>
          </div>
        `;
      }).join('');

      modalBody.innerHTML = `
        ${knowledge.thumbnailUrl ? `<img src="${knowledge.thumbnailUrl}" alt="${knowledge.title}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 5px; margin-bottom: 20px;">` : ''}
        <p><strong>URL:</strong> <a href="${knowledge.url}" target="_blank">${knowledge.url}</a></p>
        <p><strong>æŠ•ç¨¿è€…:</strong> ${knowledge.postedBy}</p>
        <p><strong>æŠ•ç¨¿æ—¥æ™‚:</strong> ${dateStr}</p>
        <div class="card-tags" style="margin: 15px 0;">${tagsHtml}</div>
        <p><strong>èª¬æ˜:</strong></p>
        <div class="markdown-content">${renderMarkdown(knowledge.comment || 'ï¼ˆèª¬æ˜ãªã—ï¼‰')}</div>
        <div style="margin: 20px 0;">
          <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
          <div id="commentsList">${commentsHtml || '<p>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>'}</div>
          <div style="margin-top: 20px;">
            <input type="text" id="newComment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." style="width: 70%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            <input type="text" id="commentAuthor" placeholder="ãŠåå‰" style="width: 20%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-left: 10px;">
            <button onclick="submitComment(${knowledge.id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">æŠ•ç¨¿</button>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button id="modal-like-btn-${knowledge.id}" class="like-button" onclick="addLike(${knowledge.id})" style="flex: 1;">
            â¤ï¸ ã„ã„ã­ ${knowledge.likes}
          </button>
          <button onclick="copyShareLink(${knowledge.id})" style="padding: 10px 20px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 16px;">
             ğŸ”— ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
          </button>
          <button onclick="openEditModal(${knowledge.id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ç·¨é›†
          </button>
        </div>
      `;

      modal.classList.add('active');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
      // URLã‚’æˆ»ã™
      const url = new URL(window.location.href);
      if (url.searchParams.has('id')) {
        url.searchParams.delete('id');
        // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ ? ã‚‚æ¶ˆã—ãŸã„ãŒã€GASã®URLæ§‹é€ ä¸Š search ã ã‘ç½®æ›ã§OKã‹ç¢ºèª
        // pushStateã®ç¬¬ä¸‰å¼•æ•°ã¯ãƒ‘ã‚¹ã¾ãŸã¯ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—
        window.history.pushState({ id: null }, '', url.pathname + url.search);
      }
      document.getElementById('detailModal').classList.remove('active');
    }

    // å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
    function copyShareLink(id) {
      const normalizedId = normalizeKnowledgeId(id);
      if (normalizedId === null) {
        alert('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆIDãŒä¸æ­£ã§ã™ï¼‰');
        return;
      }

      const baseUrl = SERVER_DATA.appUrl || window.location.href.split('?')[0];
      const shareUrl = `${baseUrl}?id=${normalizedId}`;

      navigator.clipboard.writeText(shareUrl).then(() => {
        alert('å…±æœ‰ç”¨URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n' + shareUrl);
      }).catch(err => {
        console.error('Failed to copy:', err);
        prompt('ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', shareUrl);
      });
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
    function submitComment(knowledgeId) {
      const commentText = document.getElementById('newComment').value;
      const author = document.getElementById('commentAuthor').value || 'åŒ¿å';

      if (!commentText.trim()) {
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      google.script.run
        .withSuccessHandler(function (success) {
          if (success) {
            document.getElementById('newComment').value = '';
            document.getElementById('commentAuthor').value = '';
            showDetail(knowledgeId);
          } else {
            showError('ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(showError)
        .addComment(knowledgeId, commentText, author);
    }

    // ã„ã„ã­ã‚’è¿½åŠ 
    function addLike(knowledgeId) {
      google.script.run
        .withSuccessHandler(function (newLikes) {
          // ä¸€è¦§ã®ã‚«ãƒ¼ãƒ‰ã®ã„ã„ã­ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
          const cardBtn = document.getElementById(`like-btn-${knowledgeId}`);
          if (cardBtn) {
            cardBtn.textContent = `â¤ï¸ ${newLikes}`;
          }

          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã„ã„ã­ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
          const modalBtn = document.getElementById(`modal-like-btn-${knowledgeId}`);
          if (modalBtn) {
            modalBtn.textContent = `â¤ï¸ ã„ã„ã­ ${newLikes}`;
          }

          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆallKnowledgeï¼‰ã‚‚æ›´æ–°ã—ã¦ãŠãï¼ˆæ¬¡å›ã®è©³ç´°è¡¨ç¤ºã®ãŸã‚ï¼‰
          const localData = allKnowledge.find(k => k.id === knowledgeId);
          if (localData) {
            localData.likes = newLikes;
          }
        })
        .withFailureHandler(function (error) {
          console.error('Error adding like:', error);
          showError('ã„ã„ã­ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .addLike(knowledgeId);
    }

    // ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    function showError(error) {
      console.error('showError called with:', error);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›
      const errorMessage = error?.message || error?.toString() || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';

      // æ—¢å­˜ã®ä¸€è¦§ã‚’æ¶ˆã•ãšã«ã€ãƒˆãƒ¼ã‚¹ãƒˆã¾ãŸã¯ã‚¢ãƒ©ãƒ¼ãƒˆã§é€šçŸ¥
      // ã‚‚ã—è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã“ã†ã¨ã—ã¦ã„ãŸãªã‚‰ã€ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ã‹é–‰ã˜ã‚‹
      alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${errorMessage}`);

      // ã‚‚ã—ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºä¸­ãªã‚‰æ¶ˆã™
      const grid = document.getElementById('knowledgeGrid');
      if (grid && grid.innerHTML.includes('class="loading"')) {
        // ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒä½•ã‚‚ãªã„ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ï¼‰å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ã¦ã‚‚è‰¯ã„
        grid.innerHTML = `<div class="error">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}</div>`;
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.onclick = function (event) {
      const detailModal = document.getElementById('detailModal');
      const addModal = document.getElementById('addModal');
      const editModal = document.getElementById('editModal');
      if (event.target === detailModal) {
        closeModal();
      }
      if (event.target === addModal) {
        closeAddModal();
      }
      if (event.target === editModal) {
        closeEditModal();
      }
    }

    // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openAddModal() {
      document.getElementById('addModal').classList.add('active');
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('addKnowledgeForm').reset();
    }

    // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeAddModal() {
      document.getElementById('addModal').classList.remove('active');
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ 
    function submitKnowledge(event) {
      event.preventDefault();

      const knowledge = {
        title: document.getElementById('addTitle').value.trim(),
        url: document.getElementById('addUrl').value.trim(),
        comment: document.getElementById('addComment').value.trim(),
        tags: document.getElementById('addTags').value.trim(),
        postedBy: document.getElementById('addPostedBy').value.trim(),
        thumbnailUrl: document.getElementById('addThumbnailUrl').value.trim(),
      };

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!knowledge.title || !knowledge.url || !knowledge.postedBy) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã€URLã€æŠ•ç¨¿è€…ã¯å¿…é ˆé …ç›®ã§ã™');
        return;
      }

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const submitButton = event.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'è¿½åŠ ä¸­...';

      google.script.run
        .withSuccessHandler(function (result) {
          try {
            const response = typeof result === 'string' ? JSON.parse(result) : result;
            if (response.success) {
              closeAddModal();
              loadKnowledge(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
              alert('ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
            } else {
              alert('ã‚¨ãƒ©ãƒ¼: ' + (response.error || 'ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .withFailureHandler(function (error) {
          console.error('Error adding knowledge:', error);
          alert('ã‚¨ãƒ©ãƒ¼: ' + (error?.message || 'ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .addKnowledge(knowledge);
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openEditModal(knowledgeId) {
      // ã¾ãšè©³ç´°ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function (result) {
          let knowledge;
          if (typeof result === 'string') {
            try {
              knowledge = JSON.parse(result);
            } catch (e) {
              console.error('Failed to parse JSON:', e);
              showError('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
              return;
            }
          } else {
            knowledge = result;
          }

          if (!knowledge || knowledge === null) {
            alert('ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            return;
          }

          // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
          document.getElementById('editKnowledgeId').value = knowledgeId;
          document.getElementById('editTitle').value = knowledge.title || '';
          document.getElementById('editUrl').value = knowledge.url || '';
          document.getElementById('editComment').value = knowledge.comment || '';
          document.getElementById('editTags').value = (knowledge.tags || []).join(',');
          document.getElementById('editPostedBy').value = knowledge.postedBy || '';
          document.getElementById('editThumbnailUrl').value = knowledge.thumbnailUrl || '';

          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
          document.getElementById('editModal').classList.add('active');
        })
        .withFailureHandler(function (error) {
          console.error('Error loading knowledge for edit:', error);
          alert('ãƒŠãƒ¬ãƒƒã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getKnowledgeDetail(knowledgeId);
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ›´æ–°
    function submitUpdate(event) {
      event.preventDefault();

      const knowledgeId = parseInt(document.getElementById('editKnowledgeId').value);
      const knowledge = {
        title: document.getElementById('editTitle').value.trim(),
        url: document.getElementById('editUrl').value.trim(),
        comment: document.getElementById('editComment').value.trim(),
        tags: document.getElementById('editTags').value.trim(),
        postedBy: document.getElementById('editPostedBy').value.trim(),
        thumbnailUrl: document.getElementById('editThumbnailUrl').value.trim(),
      };

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!knowledge.title || !knowledge.url || !knowledge.postedBy) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã€URLã€æŠ•ç¨¿è€…ã¯å¿…é ˆé …ç›®ã§ã™');
        return;
      }

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const submitButton = event.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'æ›´æ–°ä¸­...';

      google.script.run
        .withSuccessHandler(function (result) {
          try {
            const response = typeof result === 'string' ? JSON.parse(result) : result;
            if (response.success) {
              closeEditModal();
              closeModal(); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚é–‰ã˜ã‚‹
              loadKnowledge(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
              alert('ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
            } else {
              alert('ã‚¨ãƒ©ãƒ¼: ' + (response.error || 'ãƒŠãƒ¬ãƒƒã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('ãƒŠãƒ¬ãƒƒã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .withFailureHandler(function (error) {
          console.error('Error updating knowledge:', error);
          alert('ã‚¨ãƒ©ãƒ¼: ' + (error?.message || 'ãƒŠãƒ¬ãƒƒã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .updateKnowledge(knowledgeId, knowledge);
    }
  </script>
</body>

</html>
