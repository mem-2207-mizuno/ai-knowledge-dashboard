<script>
    const referenceData = SERVER_DATA.referenceData || {};
    const CATEGORY_CONFIG = [
      { id: 'all', label: 'ã™ã¹ã¦', icon: 'ğŸŒ' },
      { id: 'article', label: 'æ°—ã«ãªã‚‹è¨˜äº‹', icon: 'ğŸ“°' },
      { id: 'question', label: 'ç›¸è«‡ãƒ»è³ªå•', icon: 'â“' },
      { id: 'recruitment', label: 'ä»²é–“å‹Ÿé›†', icon: 'ğŸ¤' },
      { id: 'showcase', label: 'æˆæœç‰©ç´¹ä»‹', icon: 'ğŸ' },
    ];

    const CATEGORY_FORM_CONFIGS = Array.isArray(referenceData.categories)
      ? referenceData.categories
      : [];
    const KNOWN_TAGS = Array.isArray(referenceData.tags) ? referenceData.tags : [];

    const DEFAULT_CATEGORY_KEY = 'article';
    const FORM_CATEGORY_OPTIONS =
      CATEGORY_FORM_CONFIGS.length > 0
        ? CATEGORY_FORM_CONFIGS
        : CATEGORY_CONFIG.filter((config) => config.id && config.id !== 'all').map(
            (config) => ({
              key: config.id,
              label: config.label,
              icon: config.icon,
              metadataFields: [],
            })
          );
    const DEFAULT_CATEGORY_VALUE =
      FORM_CATEGORY_OPTIONS.find((config) => config.key === DEFAULT_CATEGORY_KEY)?.key ||
      (FORM_CATEGORY_OPTIONS[0] ? FORM_CATEGORY_OPTIONS[0].key : '');

    let addMarkdownEditor = null;
    let editMarkdownEditor = null;

    const EASYMDE_OPTIONS = {
      spellChecker: false,
      status: false,
      autoDownloadFontAwesome: false,
      renderingConfig: {
        singleLineBreaks: false,
      },
      toolbar: [
        'bold',
        'italic',
        'heading',
        '|',
        'quote',
        'unordered-list',
        'ordered-list',
        '|',
        'link',
        'code',
        '|',
        'preview',
        'side-by-side',
        'fullscreen',
        '|',
        'guide',
      ],
    };

    function initMarkdownEditors() {
      if (typeof EasyMDE === 'undefined') {
        console.warn('EasyMDE is not loaded.');
        return;
      }
      const addTextarea = document.getElementById('addComment');
      if (addTextarea && !addMarkdownEditor) {
        addMarkdownEditor = new EasyMDE(
          Object.assign({}, EASYMDE_OPTIONS, {
            element: addTextarea,
            placeholder: 'Markdownã§è©³ç´°ã‚’è¨˜è¿°ã§ãã¾ã™',
          })
        );
      }
      const editTextarea = document.getElementById('editComment');
      if (editTextarea && !editMarkdownEditor) {
        editMarkdownEditor = new EasyMDE(
          Object.assign({}, EASYMDE_OPTIONS, {
            element: editTextarea,
            placeholder: 'Markdownã§è©³ç´°ã‚’è¨˜è¿°ã§ãã¾ã™',
          })
        );
      }
    }

    function getMarkdownValue(editor, textareaId) {
      if (editor && typeof editor.value === 'function') {
        return editor.value().trim();
      }
      const textarea = document.getElementById(textareaId);
      return textarea ? textarea.value.trim() : '';
    }

    function setMarkdownValue(editor, textareaId, value) {
      const resolved = value || '';
      if (editor && typeof editor.value === 'function') {
        editor.value(resolved);
        return;
      }
      const textarea = document.getElementById(textareaId);
      if (textarea) {
        textarea.value = resolved;
      }
    }

    function refreshMarkdownEditor(editor) {
      if (editor && editor.codemirror) {
        setTimeout(() => editor.codemirror.refresh(), 0);
      }
    }

    const TAG_INPUT_STATE = {
      add: [],
      edit: [],
    };

    function escapeHtml(value) {
      if (typeof value !== 'string') {
        return '';
      }
      return value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function hydrateTagSuggestionList() {
      const datalist = document.getElementById('tagSuggestionsList');
      if (!datalist) {
        return;
      }
      datalist.innerHTML = KNOWN_TAGS.map((tag) => `<option value="${escapeHtml(tag.name)}"></option>`).join('');
    }

    function getTagInputElement(mode) {
      return document.getElementById(mode === 'add' ? 'addTagInput' : 'editTagInput');
    }

    function setupTagInputs() {
      hydrateTagSuggestionList();
      ['add', 'edit'].forEach((mode) => {
        const input = getTagInputElement(mode);
        if (input && !input.dataset.listenerAttached) {
          input.addEventListener('keydown', (event) => handleTagInputKeydown(event, mode));
          input.addEventListener('blur', () => commitTagFromInputElement(input, mode));
          input.dataset.listenerAttached = 'true';
        }
        setupTagChipRemoval(mode);
      });
    }

    function handleTagInputKeydown(event, mode) {
      if (event.key === 'Enter' || event.key === ',') {
        event.preventDefault();
        commitTagFromInputElement(event.target, mode);
        return;
      }
      if (
        event.key === 'Backspace' &&
        event.target.value === '' &&
        TAG_INPUT_STATE[mode] &&
        TAG_INPUT_STATE[mode].length > 0
      ) {
        TAG_INPUT_STATE[mode].pop();
        renderTagChips(mode);
      }
    }

    function setupTagChipRemoval(mode) {
      const containerId = mode === 'add' ? 'addTagChips' : 'editTagChips';
      const container = document.getElementById(containerId);
      if (!container || container.dataset.listenerAttached) {
        return;
      }
      container.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-tag]');
        if (!button) {
          return;
        }
        const tagValue = button.getAttribute('data-tag');
        removeTag(mode, tagValue);
      });
      container.dataset.listenerAttached = 'true';
    }

    function commitTagFromInputElement(inputElement, mode) {
      if (!inputElement) {
        return;
      }
      const rawValue = inputElement.value || '';
      const normalized = rawValue.trim();
      if (normalized) {
        if (!TAG_INPUT_STATE[mode]) {
          TAG_INPUT_STATE[mode] = [];
        }
        if (!TAG_INPUT_STATE[mode].includes(normalized)) {
          TAG_INPUT_STATE[mode].push(normalized);
          renderTagChips(mode);
        }
      }
      inputElement.value = '';
    }

    function commitPendingTagInput(mode) {
      const input = getTagInputElement(mode);
      if (input && input.value) {
        commitTagFromInputElement(input, mode);
      }
    }

    function removeTag(mode, targetTag) {
      if (!targetTag || !TAG_INPUT_STATE[mode]) {
        return;
      }
      const index = TAG_INPUT_STATE[mode].indexOf(targetTag);
      if (index > -1) {
        TAG_INPUT_STATE[mode].splice(index, 1);
        renderTagChips(mode);
      }
    }

    function renderTagChips(mode) {
      const containerId = mode === 'add' ? 'addTagChips' : 'editTagChips';
      const container = document.getElementById(containerId);
      if (!container) {
        return;
      }
      const tags = TAG_INPUT_STATE[mode] || [];
      if (tags.length === 0) {
        container.innerHTML = '<span class="tag-chip-placeholder">ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</span>';
        return;
      }
      container.innerHTML = tags
        .map(
          (tag) => `
          <span class="tag-chip tag-chip-editable">
            <span>${escapeHtml(tag)}</span>
            <button type="button" class="tag-chip-remove" data-tag="${escapeHtml(tag)}" aria-label="${escapeHtml(
            tag
          )} ã‚’å‰Šé™¤">&times;</button>
          </span>`
        )
        .join('');
    }

    function setTags(mode, tags) {
      const normalized = Array.isArray(tags)
        ? tags
        : typeof tags === 'string'
          ? tags.split(',').map((tag) => tag.trim())
          : [];
      TAG_INPUT_STATE[mode] = normalized
        .map((tag) => tag.trim())
        .filter((tag, index, arr) => tag && arr.indexOf(tag) === index);
      renderTagChips(mode);
      const input = getTagInputElement(mode);
      if (input) {
        input.value = '';
      }
    }

    function getTags(mode) {
      return TAG_INPUT_STATE[mode] ? [...TAG_INPUT_STATE[mode]] : [];
    }

    function populateCategorySelect(selectId) {
      const selectEl = document.getElementById(selectId);
      if (!selectEl) {
        return;
      }
      if (!FORM_CATEGORY_OPTIONS || FORM_CATEGORY_OPTIONS.length === 0) {
        selectEl.innerHTML = '';
        return;
      }
      selectEl.innerHTML = FORM_CATEGORY_OPTIONS.map((config) => {
        const label = `${config.icon ? `${config.icon} ` : ''}${config.label}`;
        return `<option value="${config.key}">${label}</option>`;
      }).join('');
    }

    function renderMetadataFields(mode, metadata = {}) {
      const containerId = mode === 'add' ? 'addMetadataFields' : 'editMetadataFields';
      const separatorId = mode === 'add' ? 'addMetadataSeparator' : 'editMetadataSeparator';
      const container = document.getElementById(containerId);
      const separator = document.getElementById(separatorId);
      if (!container) {
        return;
      }
      const selectEl = document.getElementById(mode === 'add' ? 'addCategory' : 'editCategory');
      if (!selectEl) {
        container.innerHTML = '';
        if (separator) separator.style.display = 'none';
        return;
      }
      const categoryKey = selectEl.value;
      const config = CATEGORY_FORM_CONFIGS.find((cat) => cat.key === categoryKey);
      if (!config || !config.metadataFields || config.metadataFields.length === 0) {
        container.innerHTML = '';
        if (separator) separator.style.display = 'none';
        return;
      }
      if (separator) separator.style.display = 'block';
      container.innerHTML = config.metadataFields
        .map((field) => createMetadataFieldMarkup(field, metadata[field.key], mode))
        .join('');
    }

    function createMetadataFieldMarkup(field, value, mode) {
      const containerId = `${mode}-meta-${field.key}`;
      const requiredAttr = field.required ? 'required' : '';
      const placeholderAttr = field.placeholder ? `placeholder="${escapeHtml(field.placeholder)}"` : '';
      const helper = field.helperText
        ? `<div class="property-helper">${escapeHtml(field.helperText)}</div>`
        : '';
      let resolvedValue = '';
      if (Array.isArray(value)) {
        resolvedValue = value.join(', ');
      } else if (typeof value === 'string') {
        resolvedValue = value;
      } else if (typeof field.defaultValue === 'string') {
        resolvedValue = field.defaultValue;
      }

      let inputHtml = '';
      if (field.type === 'textarea') {
        inputHtml = `<textarea id="${containerId}" data-metadata-key="${field.key}" ${requiredAttr} ${placeholderAttr}>${escapeHtml(
          resolvedValue
        )}</textarea>`;
      } else if (field.type === 'select') {
        const options =
          field.options?.map((option) => {
            const selected =
              resolvedValue && option.value === resolvedValue ? 'selected' : '';
            return `<option value="${option.value}" ${selected}>${option.label}</option>`;
          }) || [];
        inputHtml = `<select id="${containerId}" data-metadata-key="${field.key}" ${requiredAttr}>
          ${options.join('')}
        </select>`;
      } else {
        let inputType = 'text';
        if (field.type === 'url') {
          inputType = 'url';
        } else if (field.type === 'date') {
          inputType = 'date';
        }
        inputHtml = `<input type="${inputType}" id="${containerId}" data-metadata-key="${
          field.key
        }" value="${escapeHtml(resolvedValue)}" ${requiredAttr} ${placeholderAttr} />`;
      }

      return `
        <div class="property-row metadata-row">
          <div class="property-label">${field.label}${field.required ? ' *' : ''}</div>
          <div class="property-control">
            ${inputHtml}
            ${helper}
          </div>
        </div>
      `;
    }

    function collectMetadata(mode) {
      const containerId = mode === 'add' ? 'addMetadataFields' : 'editMetadataFields';
      const container = document.getElementById(containerId);
      if (!container) {
        return {};
      }
      const metadataInputs = container.querySelectorAll('[data-metadata-key]');
      const result = {};
      metadataInputs.forEach((input) => {
        const key = input.getAttribute('data-metadata-key');
        if (!key) {
          return;
        }
        let value;
        if (input.tagName === 'SELECT') {
          const selectEl = input;
          if (selectEl.multiple) {
            value = Array.from(selectEl.options)
              .filter((option) => option.selected)
              .map((option) => option.value);
          } else {
            value = selectEl.value.trim();
          }
        } else {
          value = input.value.trim();
        }
        if (Array.isArray(value) && value.length > 0) {
          result[key] = value;
        } else if (value) {
          result[key] = value;
        }
      });
      return result;
    }

    function setupFormControls() {
      populateCategorySelect('addCategory');
      populateCategorySelect('editCategory');
      const addSelect = document.getElementById('addCategory');
      if (addSelect) {
        addSelect.value = DEFAULT_CATEGORY_VALUE || addSelect.value;
        addSelect.addEventListener('change', () => renderMetadataFields('add'));
        renderMetadataFields('add');
      }
      const editSelect = document.getElementById('editCategory');
      if (editSelect) {
        if (!editSelect.value && DEFAULT_CATEGORY_VALUE) {
          editSelect.value = DEFAULT_CATEGORY_VALUE;
        }
        editSelect.addEventListener('change', () => renderMetadataFields('edit'));
        renderMetadataFields('edit');
      }
    }

    let allKnowledge = [];
    let selectedTags = [];
    let selectedCategory = 'all';
    let currentView = 'all';

    const CLIENT_ID_STORAGE_KEY = 'ai-knowledge-dashboard-client-id';
    function ensureClientId() {
      try {
        let clientId = localStorage.getItem(CLIENT_ID_STORAGE_KEY);
        if (!clientId) {
          clientId = `client-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
          localStorage.setItem(CLIENT_ID_STORAGE_KEY, clientId);
        }
        return clientId;
      } catch (error) {
        console.warn('Failed to access localStorage for client ID:', error);
        return `client-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
      }
    }
    const CLIENT_ID = ensureClientId();
    const LIKED_STORAGE_KEY = 'ai-knowledge-dashboard-liked-ids';
    let likedKnowledgeIds = loadLikedKnowledgeIds();

    function loadLikedKnowledgeIds() {
      try {
        const stored = localStorage.getItem(LIKED_STORAGE_KEY);
        if (!stored) {
          return new Set();
        }
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) {
          return new Set(parsed.map(id => id.toString()));
        }
      } catch (error) {
        console.warn('Failed to load liked IDs from storage:', error);
      }
      return new Set();
    }

    function saveLikedKnowledgeIds() {
      try {
        localStorage.setItem(LIKED_STORAGE_KEY, JSON.stringify(Array.from(likedKnowledgeIds)));
      } catch (error) {
        console.warn('Failed to save liked IDs:', error);
      }
    }

    function isKnowledgeLiked(id) {
      if (!id) {
        return false;
      }
      return likedKnowledgeIds.has(id.toString());
    }

    function markKnowledgeLiked(id) {
      if (!id) {
        return;
      }
      likedKnowledgeIds.add(id.toString());
      saveLikedKnowledgeIds();
      updateInsights();
    }

    function findKnowledgeById(id) {
      return allKnowledge.find(k => k.id == id);
    }

    function renderCommentItem(comment) {
      if (!comment) {
        return '';
      }
      const date = comment.postedAt
        ? (typeof comment.postedAt === 'string'
          ? new Date(comment.postedAt)
          : new Date(comment.postedAt))
        : new Date();
      const statusLabel = comment.pending
        ? '<span style="margin-left: 8px; color: #999; font-size: 0.9em;">é€ä¿¡ä¸­...</span>'
        : '';
      const tempAttr = comment.tempId ? `data-temp-id="${comment.tempId}"` : '';
      return `
        <div class="comment-item ${comment.pending ? 'comment-pending' : ''}" ${tempAttr}
          style="padding: 10px; margin: 10px 0; background: #f5f5f5; border-radius: 5px; opacity: ${comment.pending ? '0.6' : '1'};">
          <strong>${comment.author || 'åŒ¿å'}</strong> - ${date.toLocaleString('ja-JP')} ${statusLabel}
          <div class="markdown-content" style="margin-top: 10px;">${renderMarkdown(comment.text || '')}</div>
        </div>
      `;
    }

    function renderCommentsHtml(comments) {
      if (!comments || comments.length === 0) {
        return '<p>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
      }
      return comments.map(comment => renderCommentItem(comment)).join('');
    }

    function getCategoryInfo(categoryId) {
      const normalized = categoryId || 'article';
      return CATEGORY_CONFIG.find(cat => cat.id === normalized) || CATEGORY_CONFIG.find(cat => cat.id === 'article');
    }

    function updateCategoryUI() {
      document.querySelectorAll('.category-chip').forEach(chip => {
        const cat = chip.getAttribute('data-category');
        if (cat) {
          chip.classList.toggle('active', cat === selectedCategory);
        }
      });
    }

    function setCategory(category) {
      selectedCategory = category;
      updateCategoryUI();
      filterKnowledge();
    }

    function updateViewUI() {
      document.querySelectorAll('.nav-item').forEach(item => {
        const view = item.getAttribute('data-view');
        if (view) {
          item.classList.toggle('active', view === currentView);
        }
      });
    }

    function setView(view) {
      currentView = view;
      updateViewUI();
      filterKnowledge();
    }

    function refreshCommentsUI(knowledgeId) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge) {
        return;
      }
      const commentsList = document.getElementById('commentsList');
      if (!commentsList) {
        return;
      }
      const comments = Array.isArray(knowledge.comments) ? knowledge.comments : [];
      commentsList.innerHTML = renderCommentsHtml(comments);
    }

    function addOptimisticComment(knowledgeId, comment) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge) {
        return;
      }
      if (!Array.isArray(knowledge.comments)) {
        knowledge.comments = [];
      }
      knowledge.comments.push(comment);
      refreshCommentsUI(knowledgeId);
      updateInsights();
    }

    function removeOptimisticComment(knowledgeId, tempId) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge || !Array.isArray(knowledge.comments)) {
        return;
      }
      knowledge.comments = knowledge.comments.filter(comment => comment.tempId !== tempId);
      refreshCommentsUI(knowledgeId);
      updateInsights();
    }

    function confirmOptimisticComment(knowledgeId, tempId) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge || !Array.isArray(knowledge.comments)) {
        return;
      }
      const comment = knowledge.comments.find(c => c.tempId === tempId);
      if (!comment) {
        return;
      }
      comment.pending = false;
      delete comment.tempId;
      comment.postedAt = new Date();
      refreshCommentsUI(knowledgeId);
      updateInsights();
    }

    function updateLikeDisplay(knowledgeId, likes, pending = false) {
      const liked = isKnowledgeLiked(knowledgeId);
      const cardBtn = document.getElementById(`like-btn-${knowledgeId}`);
      if (cardBtn) {
        cardBtn.textContent = liked ? `â¤ï¸ æ¸ˆ ${likes}` : `â¤ï¸ ${likes}`;
        cardBtn.classList.toggle('liked', liked);
        cardBtn.disabled = liked || pending;
        cardBtn.style.opacity = pending ? '0.6' : '1';
      }

      const modalBtn = document.getElementById(`modal-like-btn-${knowledgeId}`);
      if (modalBtn) {
        modalBtn.textContent = liked ? `â¤ï¸ ã„ã„ã­æ¸ˆ ${likes}` : `â¤ï¸ ã„ã„ã­ ${likes}`;
        modalBtn.classList.toggle('liked', liked);
        modalBtn.disabled = liked || pending;
        modalBtn.style.opacity = pending ? '0.6' : '1';
      }
    }

    // IDã®æ­£è¦åŒ–ï¼ˆæ•°å€¤ã®ã¿ã‚’æœ‰åŠ¹ã¨ã™ã‚‹ï¼‰
    function normalizeKnowledgeId(rawId) {
      if (rawId === null || rawId === undefined) {
        return null;
      }

      if (typeof rawId === 'number') {
        return Number.isFinite(rawId) && rawId > 0 ? Math.floor(rawId) : null;
      }

      if (typeof rawId === 'string') {
        const trimmed = rawId.trim();
        if (trimmed === '') {
          return null;
        }
        const parsed = parseInt(trimmed, 10);
        return Number.isNaN(parsed) || parsed <= 0 ? null : parsed;
      }

      return null;
    }

    // Markdownã‚’HTMLã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function renderMarkdown(markdown) {
      if (!markdown || typeof markdown !== 'string') {
        return '';
      }

      try {
        // marked.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (typeof marked !== 'undefined') {
          // XSSå¯¾ç­–: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
          marked.setOptions({
            breaks: true, // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
            gfm: true, // GitHub Flavored Markdownã‚’æœ‰åŠ¹åŒ–
          });
          return marked.parse(markdown);
        } else {
          // marked.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
          return markdown.replace(/\n/g, '<br>');
        }
      } catch (error) {
        console.error('Error rendering markdown:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
        return markdown.replace(/\n/g, '<br>');
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã‚’å–å¾—
    window.onload = function () {
      initMarkdownEditors();
      setupFormControls();
      setupTagInputs();
      setTags('add', []);
      setTags('edit', []);
      updateCategoryUI();
      updateViewUI();
      updateInsights();
      // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã®IDãƒã‚§ãƒƒã‚¯
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸIDã®ã¿ã‚’ä¿¡é ¼ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®URLè§£æã¯è¡Œã‚ãªã„
      // (GASã®iframe URLã«ã¯äºˆæœŸã›ã¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚)
      let initialId = normalizeKnowledgeId(SERVER_DATA.initialId);
      if (initialId === null) {
        console.log('No valid initialId provided by server.');
      } else {
        console.log('Parsed initialId from server:', initialId);
      }

      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸåˆæœŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
      const initialData = SERVER_DATA.initialData;
      if (initialData) {
        try {
          console.log('Loaded initial data from server');
          displayKnowledge(initialData);

          // åˆæœŸIDãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã‚’è¡¨ç¤º
          if (initialId !== null) {
            console.log('Attempting to show initial detail for ID:', initialId);
            // å°‘ã—é…å»¶ã•ã›ã¦ãƒ‡ãƒ¼ã‚¿æç”»ã‚’ç¢ºå®Ÿã«ã™ã‚‹
            setTimeout(() => {
              showDetail(initialId, false);
            }, 100);
          }
        } catch (e) {
          console.error('Failed to process initial data:', e);
          loadKnowledge(initialId); // å¤±æ•—æ™‚ã¯é€šå¸¸é€šã‚Šå–å¾—
        }
      } else {
        loadKnowledge(initialId);
      }

      // ... (popstateã‚¤ãƒ™ãƒ³ãƒˆã¯ãã®ã¾ã¾)
    };

    // ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    function loadKnowledge(openId = null) {
      console.log('Loading knowledge list...');
      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Success handler called with result:', result);
          console.log('Result type:', typeof result);

          // JSONæ–‡å­—åˆ—ã¨ã—ã¦è¿”ã£ã¦ãã‚‹å ´åˆã®å‡¦ç†
          let knowledgeList;
          if (typeof result === 'string') {
            try {
              knowledgeList = JSON.parse(result);
              console.log('Parsed knowledge list:', knowledgeList);
            } catch (e) {
              console.error('Failed to parse JSON:', e);
              showError('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
              return;
            }
          } else if (Array.isArray(result)) {
            knowledgeList = result;
          } else if (result === null || result === undefined) {
            console.error('Result is null or undefined');
            showError('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆnullãŒè¿”ã•ã‚Œã¾ã—ãŸï¼‰');
            return;
          } else {
            console.error('Unexpected result type:', typeof result, result);
            showError('äºˆæœŸã—ãªã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
            return;
          }

          displayKnowledge(knowledgeList);

          const normalizedOpenId = normalizeKnowledgeId(openId);
          if (normalizedOpenId !== null) {
            showDetail(normalizedOpenId, false);
          }
        })
        .withFailureHandler(function (error) {
          console.error('Failure handler called with error:', error);
          showError(error);
        })
        .getKnowledgeList();
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
    function displayKnowledge(knowledgeList) {
      const grid = document.getElementById('knowledgeGrid');

      // nullãƒã‚§ãƒƒã‚¯
      if (!knowledgeList) {
        grid.innerHTML = '<div class="error">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        console.error('knowledgeList is null or undefined');
        return;
      }

      // é…åˆ—ã§ãªã„å ´åˆã®å‡¦ç†
      if (!Array.isArray(knowledgeList)) {
        grid.innerHTML = '<div class="error">ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>';
        console.error('knowledgeList is not an array:', knowledgeList);
        return;
      }

      allKnowledge = knowledgeList.map(k => ({
        ...k,
        category: k.category || 'article',
        status: k.status || 'open',
        likePending: false,
        postedAt: k.postedAt ? new Date(k.postedAt) : new Date(),
        comments: Array.isArray(k.comments)
          ? k.comments.map(comment => ({
            ...comment,
            postedAt: comment.postedAt ? new Date(comment.postedAt) : new Date(),
          }))
          : [],
      }));

      if (allKnowledge.length === 0) {
        updateTagFilter([]);
        updateInsights();
        renderKnowledgeGrid([]);
        updateCategoryUI();
        updateViewUI();
        return;
      }

      // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
      updateTagFilter(allKnowledge);
      updateInsights();
      updateCategoryUI();
      updateViewUI();
      filterKnowledge();
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createKnowledgeCard(knowledge) {
      if (!knowledge) {
        return '';
      }

      const categoryInfo = getCategoryInfo(knowledge.category);
      const categoryLabel = categoryInfo ? `${categoryInfo.icon} ${categoryInfo.label}` : 'ãƒŠãƒ¬ãƒƒã‚¸';
      const statusLabel = (knowledge.status || 'open').toUpperCase();
      const date = knowledge.postedAt instanceof Date ? knowledge.postedAt : new Date(knowledge.postedAt || Date.now());
      const dateStr = date.toLocaleDateString('ja-JP');
      const tags = knowledge.tags || [];
      const tagsHtml = tags.map(tag =>
        `<span class="card-tag">${tag}</span>`
      ).join('');
      const descriptionSource = (knowledge.comment || '')
        .replace(/<[^>]+>/g, '')
        .replace(/\n+/g, ' ')
        .trim();
      const description = descriptionSource.length > 0
        ? (descriptionSource.length > 120 ? `${descriptionSource.slice(0, 120)}â€¦` : descriptionSource)
        : 'ï¼ˆèª¬æ˜ãªã—ï¼‰';

      const liked = knowledge.id ? isKnowledgeLiked(knowledge.id) : false;
      const likeButtonClass = `like-button ${liked ? 'liked' : ''}`;
      const likeButtonText = liked ? `â¤ï¸ æ¸ˆ ${knowledge.likes || 0}` : `â¤ï¸ ${knowledge.likes || 0}`;
      const likeButtonDisabled = liked ? 'disabled' : '';

      const coverHtml = knowledge.thumbnailUrl
        ? `<div class="card-cover" style="background-image:url('${knowledge.thumbnailUrl}')"></div>`
        : '';

      return `
        <div class="knowledge-card" onclick="showDetail(${knowledge.id || 0})">
          ${coverHtml}
          <div class="card-header-line">
            <span class="category-badge">${categoryLabel}</span>
            <span class="status-pill">${statusLabel}</span>
          </div>
          <div class="card-title">${knowledge.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</div>
          <div class="card-description">${description}</div>
          <div class="card-tags">${tagsHtml}</div>
          <div class="card-meta">
            <span>${knowledge.postedBy || 'ä¸æ˜'}ãƒ»${dateStr}</span>
            <button id="like-btn-${knowledge.id}" class="${likeButtonClass}" data-knowledge-id="${knowledge.id}"
              onclick="event.stopPropagation(); addLike(${knowledge.id || 0})" ${likeButtonDisabled}>
              ${likeButtonText}
            </button>
          </div>
        </div>
      `;
    }

    // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
    function updateTagFilter(knowledgeList) {
      if (!knowledgeList || !Array.isArray(knowledgeList)) {
        return;
      }

      const tagsSet = new Set();
      knowledgeList.forEach(k => {
        if (k && k.tags && Array.isArray(k.tags)) {
          k.tags.forEach(tag => {
            if (tag) {
              tagsSet.add(tag);
            }
          });
        }
      });

      const tagsFilter = document.getElementById('tagsFilter');
      if (!tagsFilter) {
        return;
      }

      tagsFilter.innerHTML = Array.from(tagsSet).map(tag =>
        `<span class="tag-chip ${selectedTags.includes(tag) ? 'active' : ''}" onclick="toggleTag('${tag}')">${tag}</span>`
      ).join('');
    }

    // ã‚¿ã‚°ã‚’ãƒˆã‚°ãƒ«
    function toggleTag(tag) {
      const index = selectedTags.indexOf(tag);
      if (index > -1) {
        selectedTags.splice(index, 1);
      } else {
        selectedTags.push(tag);
      }
      filterKnowledge();
    }

    function renderKnowledgeGrid(list) {
      const grid = document.getElementById('knowledgeGrid');
      if (!grid) {
        return;
      }
      if (!list || list.length === 0) {
        grid.innerHTML = '<div class="loading">è¡¨ç¤ºã§ãã‚‹ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }
      grid.innerHTML = list.map(k => createKnowledgeCard(k)).join('');
    }

    function updateInsights() {
      const totalEl = document.getElementById('statTotalPosts');
      if (totalEl) {
        totalEl.textContent = allKnowledge.length.toString();
      }
      const favoriteEl = document.getElementById('statFavorites');
      if (favoriteEl) {
        favoriteEl.textContent = likedKnowledgeIds.size.toString();
      }
      const commentCount = allKnowledge.reduce((sum, item) => {
        return sum + (item.comments ? item.comments.length : 0);
      }, 0);
      const commentsEl = document.getElementById('statComments');
      if (commentsEl) {
        commentsEl.textContent = commentCount.toString();
      }
    }

    // æ¤œç´¢
    function searchKnowledge() {
      filterKnowledge();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterKnowledge() {
      const searchInput = document.getElementById('searchInput');
      const searchWord = searchInput ? searchInput.value.toLowerCase() : '';

      // ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ
      const filteredList = allKnowledge.filter(k => {
        const normalizedCategory = k.category || 'article';
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
        let matchesSearch = true;
        if (searchWord) {
          matchesSearch =
            (k.title && k.title.toLowerCase().includes(searchWord)) ||
            (k.comment && k.comment.toLowerCase().includes(searchWord)) ||
            (k.url && k.url.toLowerCase().includes(searchWord));
        }

        // ã‚¿ã‚°æ¤œç´¢
        let matchesTags = true;
        if (selectedTags.length > 0) {
          matchesTags = selectedTags.some(tag => k.tags && k.tags.includes(tag));
        }

        const matchesCategory = selectedCategory === 'all' || normalizedCategory === selectedCategory;
        const matchesView = currentView === 'all' ? true : isKnowledgeLiked(k.id);

        return matchesSearch && matchesTags && matchesCategory && matchesView;
      });

      renderKnowledgeGrid(filteredList);

      // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã®è¡¨ç¤ºã‚’æ›´æ–°
      document.querySelectorAll('.tag-chip').forEach(chip => {
        const tag = chip.textContent;
        if (selectedTags.includes(tag)) {
          chip.classList.add('active');
        } else {
          chip.classList.remove('active');
        }
      });
    }

    // è©³ç´°ã‚’è¡¨ç¤º
    function showDetail(id, updateHistory = true) {
      const normalizedId = normalizeKnowledgeId(id);
      if (normalizedId === null) {
        console.warn('showDetail was called with an invalid ID:', id);
        return;
      }

      // URLæ›´æ–°
      if (updateHistory) {
        // GASã®exec URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å½¢å¼ã«åˆã‚ã›ã‚‹
        // ç¾åœ¨ã®URLã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ /ç½®æ›
        const url = new URL(window.location.href);
        url.searchParams.set('id', normalizedId.toString());
        // pushStateã§å±¥æ­´ã«è¿½åŠ 
        if (url.href !== window.location.href) {
          window.history.pushState({ id: normalizedId }, '', url.search);
        }
      }

      // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸€è¦§å–å¾—æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã‹ã‚‰æ¢ã™
      // å‹å¤‰æ›ã—ã¦æ¯”è¼ƒ (==) ã‚’ä½¿ç”¨ã—ã¦æŸ”è»Ÿã«ãƒãƒƒãƒã•ã›ã‚‹
      console.log('Searching knowledge with id:', normalizedId);
      const knowledge = allKnowledge.find(k => k.id == normalizedId);

      if (knowledge) {
        console.log('Displaying detail from local data:', knowledge.title);
        displayDetail(knowledge);
      } else {
        console.log('Knowledge not found in local data, fetching from server...');
        google.script.run
          .withSuccessHandler(function (result) {
            // JSONæ–‡å­—åˆ—ã¨ã—ã¦è¿”ã£ã¦ãã‚‹å ´åˆã®å‡¦ç†
            let knowledge;
            if (typeof result === 'string') {
              try {
                knowledge = JSON.parse(result);
              } catch (e) {
                console.error('Failed to parse JSON:', e);
                alert('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
              }
            } else {
              knowledge = result;
            }
            displayDetail(knowledge);
          })
          .withFailureHandler(function (error) {
            console.error('Failed to fetch detail:', error);
            alert('è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ID: ' + normalizedId);
          })
          .getKnowledgeDetail(normalizedId);
      }
    }

    // è©³ç´°ã‚’è¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
    function displayDetail(knowledge) {
      if (!knowledge || knowledge === null) {
        showError('ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }

      const localIndex = allKnowledge.findIndex(k => k.id == knowledge.id);
      if (localIndex === -1) {
        allKnowledge.push(knowledge);
      } else {
        allKnowledge[localIndex] = knowledge;
      }

      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = knowledge.title;

      // postedAtãŒæ–‡å­—åˆ—ã®å ´åˆã‚‚Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
      const date = knowledge.postedAt
        ? (typeof knowledge.postedAt === 'string'
          ? new Date(knowledge.postedAt)
          : new Date(knowledge.postedAt))
        : new Date();
      const dateStr = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP');

      const categoryInfo = getCategoryInfo(knowledge.category);
      const categoryLabel = categoryInfo ? `${categoryInfo.icon} ${categoryInfo.label}` : 'ãƒŠãƒ¬ãƒƒã‚¸';
      const statusLabel = (knowledge.status || 'open').toUpperCase();

      const tagsHtml = (knowledge.tags || []).map(tag =>
        `<span class="card-tag">${tag}</span>`
      ).join('');

      const commentsArray = Array.isArray(knowledge.comments) ? knowledge.comments : [];
      const commentsHtml = renderCommentsHtml(commentsArray);
      const isLiked = knowledge.id ? isKnowledgeLiked(knowledge.id) : false;
      const likesCount = knowledge.likes || 0;
      const modalLikeLabel = isLiked ? `â¤ï¸ ã„ã„ã­æ¸ˆ ${likesCount}` : `â¤ï¸ ã„ã„ã­ ${likesCount}`;
      const modalLikeClass = `like-button ${isLiked ? 'liked' : ''}`;
      const modalLikeDisabled = isLiked ? 'disabled' : '';

      const knowledgeUrl = knowledge.url || '';
      const urlMarkup = knowledgeUrl
        ? `<a href="${knowledgeUrl}" target="_blank">${knowledgeUrl}</a>`
        : 'URLã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';

      modalBody.innerHTML = `
        <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px;">
          <span class="category-badge">${categoryLabel}</span>
          <span class="status-pill">${statusLabel}</span>
        </div>
        ${knowledge.thumbnailUrl ? `<img src="${knowledge.thumbnailUrl}" alt="${knowledge.title}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 5px; margin-bottom: 20px;">` : ''}
        <p><strong>URL:</strong> ${urlMarkup}</p>
        <p><strong>æŠ•ç¨¿è€…:</strong> ${knowledge.postedBy}</p>
        <p><strong>æŠ•ç¨¿æ—¥æ™‚:</strong> ${dateStr}</p>
        <div class="card-tags" style="margin: 15px 0;">${tagsHtml}</div>
        <p><strong>èª¬æ˜:</strong></p>
        <div class="markdown-content">${renderMarkdown(knowledge.comment || 'ï¼ˆèª¬æ˜ãªã—ï¼‰')}</div>
        <div style="margin: 20px 0;">
          <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
          <div id="commentsList">${commentsHtml}</div>
          <div style="margin-top: 20px;">
            <input type="text" id="newComment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." style="width: 70%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            <input type="text" id="commentAuthor" placeholder="ãŠåå‰" style="width: 20%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-left: 10px;">
            <button onclick="submitComment(${knowledge.id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">æŠ•ç¨¿</button>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button id="modal-like-btn-${knowledge.id}" class="${modalLikeClass}" onclick="addLike(${knowledge.id})" style="flex: 1;" ${modalLikeDisabled}>
            ${modalLikeLabel}
          </button>
          <button onclick="copyShareLink(${knowledge.id})" style="padding: 10px 20px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 16px;">
             ğŸ”— ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
          </button>
          <button onclick="openEditModal(${knowledge.id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ç·¨é›†
          </button>
        </div>
      `;

      modal.classList.add('active');
      updateLikeDisplay(knowledge.id, knowledge.likes, knowledge.likePending);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
      // URLã‚’æˆ»ã™
      const url = new URL(window.location.href);
      if (url.searchParams.has('id')) {
        url.searchParams.delete('id');
        // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ ? ã‚‚æ¶ˆã—ãŸã„ãŒã€GASã®URLæ§‹é€ ä¸Š search ã ã‘ç½®æ›ã§OKã‹ç¢ºèª
        // pushStateã®ç¬¬ä¸‰å¼•æ•°ã¯ãƒ‘ã‚¹ã¾ãŸã¯ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—
        window.history.pushState({ id: null }, '', url.pathname + url.search);
      }
      document.getElementById('detailModal').classList.remove('active');
    }

    // å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
    function copyShareLink(id) {
      const normalizedId = normalizeKnowledgeId(id);
      if (normalizedId === null) {
        alert('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆIDãŒä¸æ­£ã§ã™ï¼‰');
        return;
      }

      const baseUrl = SERVER_DATA.appUrl || window.location.href.split('?')[0];
      const shareUrl = `${baseUrl}?id=${normalizedId}`;

      navigator.clipboard.writeText(shareUrl).then(() => {
        alert('å…±æœ‰ç”¨URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n' + shareUrl);
      }).catch(err => {
        console.error('Failed to copy:', err);
        prompt('ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', shareUrl);
      });
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
    function submitComment(knowledgeId) {
      const commentText = document.getElementById('newComment').value;
      const author = document.getElementById('commentAuthor').value || 'åŒ¿å';

      if (!commentText.trim()) {
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const tempId = `temp-${knowledgeId}-${Date.now()}`;
      const optimisticComment = {
        tempId,
        text: commentText,
        author,
        postedAt: new Date(),
        pending: true,
      };

      document.getElementById('newComment').value = '';
      document.getElementById('commentAuthor').value = '';
      addOptimisticComment(knowledgeId, optimisticComment);

      google.script.run
        .withSuccessHandler(function (success) {
          if (success) {
            confirmOptimisticComment(knowledgeId, tempId);
            loadKnowledge(knowledgeId);
          } else {
            removeOptimisticComment(knowledgeId, tempId);
            showError('ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function (error) {
          removeOptimisticComment(knowledgeId, tempId);
          showError(error);
        })
        .addComment(knowledgeId, commentText, author);
    }

    // ã„ã„ã­ã‚’è¿½åŠ 
    function addLike(knowledgeId) {
      const knowledge = findKnowledgeById(knowledgeId);
      if (!knowledge) {
        showError('ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }
      if (isKnowledgeLiked(knowledgeId)) {
        return;
      }

      if (knowledge.likePending) {
        return;
      }

      const originalLikes = knowledge.likes || 0;
      knowledge.likePending = true;
      knowledge.likes = originalLikes + 1;
      updateLikeDisplay(knowledgeId, knowledge.likes, true);

      google.script.run
        .withSuccessHandler(function (newLikes) {
          knowledge.likes = newLikes;
          knowledge.likePending = false;
          markKnowledgeLiked(knowledgeId);
          updateLikeDisplay(knowledgeId, newLikes, false);
        })
        .withFailureHandler(function (error) {
          console.error('Error adding like:', error);
          knowledge.likes = originalLikes;
          knowledge.likePending = false;
          updateLikeDisplay(knowledgeId, originalLikes, false);
          showError('ã„ã„ã­ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .addLike(knowledgeId, CLIENT_ID);
    }

    // ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    function showError(error) {
      console.error('showError called with:', error);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›
      const errorMessage = error?.message || error?.toString() || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';

      // æ—¢å­˜ã®ä¸€è¦§ã‚’æ¶ˆã•ãšã«ã€ãƒˆãƒ¼ã‚¹ãƒˆã¾ãŸã¯ã‚¢ãƒ©ãƒ¼ãƒˆã§é€šçŸ¥
      // ã‚‚ã—è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã“ã†ã¨ã—ã¦ã„ãŸãªã‚‰ã€ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ã‹é–‰ã˜ã‚‹
      alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${errorMessage}`);

      // ã‚‚ã—ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºä¸­ãªã‚‰æ¶ˆã™
      const grid = document.getElementById('knowledgeGrid');
      if (grid && grid.innerHTML.includes('class="loading"')) {
        // ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒä½•ã‚‚ãªã„ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ï¼‰å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ã¦ã‚‚è‰¯ã„
        grid.innerHTML = `<div class="error">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}</div>`;
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.onclick = function (event) {
      const detailModal = document.getElementById('detailModal');
      const addModal = document.getElementById('addModal');
      const editModal = document.getElementById('editModal');
      if (event.target === detailModal) {
        closeModal();
      }
      if (event.target === addModal) {
        closeAddModal();
      }
      if (event.target === editModal) {
        closeEditModal();
      }
    }

    // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openAddModal() {
      document.getElementById('addModal').classList.add('active');
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('addKnowledgeForm').reset();
      setMarkdownValue(addMarkdownEditor, 'addComment', '');
      refreshMarkdownEditor(addMarkdownEditor);
      const categorySelect = document.getElementById('addCategory');
      if (categorySelect) {
        categorySelect.value = DEFAULT_CATEGORY_VALUE || categorySelect.value;
        renderMetadataFields('add');
      }
      setTags('add', []);
    }

    // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeAddModal() {
      document.getElementById('addModal').classList.remove('active');
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ 
    function submitKnowledge(event) {
      event.preventDefault();

      commitPendingTagInput('add');
      const tagValues = getTags('add');
      const metadata = collectMetadata('add');
      const categorySelect = document.getElementById('addCategory');
      const categoryValue = categorySelect ? categorySelect.value : '';

      const knowledge = {
        title: document.getElementById('addTitle').value.trim(),
        url: document.getElementById('addUrl').value.trim(),
        comment: getMarkdownValue(addMarkdownEditor, 'addComment'),
        tags: tagValues,
        postedBy: document.getElementById('addPostedBy').value.trim(),
        thumbnailUrl: document.getElementById('addThumbnailUrl').value.trim(),
        category: categoryValue,
        metadata,
      };

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!knowledge.title || !knowledge.url || !knowledge.postedBy) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã€URLã€æŠ•ç¨¿è€…ã¯å¿…é ˆé …ç›®ã§ã™');
        return;
      }

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const submitButton = event.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'è¿½åŠ ä¸­...';

      google.script.run
        .withSuccessHandler(function (result) {
          try {
            const response = typeof result === 'string' ? JSON.parse(result) : result;
            if (response.success) {
              closeAddModal();
              loadKnowledge(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
              alert('ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
            } else {
              alert('ã‚¨ãƒ©ãƒ¼: ' + (response.error || 'ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .withFailureHandler(function (error) {
          console.error('Error adding knowledge:', error);
          alert('ã‚¨ãƒ©ãƒ¼: ' + (error?.message || 'ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .addKnowledge(knowledge);
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openEditModal(knowledgeId) {
      // ã¾ãšè©³ç´°ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function (result) {
          let knowledge;
          if (typeof result === 'string') {
            try {
              knowledge = JSON.parse(result);
            } catch (e) {
              console.error('Failed to parse JSON:', e);
              showError('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
              return;
            }
          } else {
            knowledge = result;
          }

          if (!knowledge || knowledge === null) {
            alert('ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            return;
          }

          // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
          document.getElementById('editKnowledgeId').value = knowledgeId;
          document.getElementById('editTitle').value = knowledge.title || '';
          document.getElementById('editUrl').value = knowledge.url || '';
          setMarkdownValue(editMarkdownEditor, 'editComment', knowledge.comment || '');
          document.getElementById('editPostedBy').value = knowledge.postedBy || '';
          document.getElementById('editThumbnailUrl').value = knowledge.thumbnailUrl || '';
          const editCategorySelect = document.getElementById('editCategory');
          if (editCategorySelect) {
            editCategorySelect.value =
              knowledge.category || editCategorySelect.value || DEFAULT_CATEGORY_VALUE || '';
            renderMetadataFields('edit', knowledge.metadata || {});
          } else {
            renderMetadataFields('edit', knowledge.metadata || {});
          }
          setTags('edit', knowledge.tags || []);

          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
          document.getElementById('editModal').classList.add('active');
          refreshMarkdownEditor(editMarkdownEditor);
        })
        .withFailureHandler(function (error) {
          console.error('Error loading knowledge for edit:', error);
          alert('ãƒŠãƒ¬ãƒƒã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getKnowledgeDetail(knowledgeId);
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ›´æ–°
    function submitUpdate(event) {
      event.preventDefault();

      const knowledgeId = parseInt(document.getElementById('editKnowledgeId').value);
      commitPendingTagInput('edit');
      const editTagValues = getTags('edit');
      const editMetadata = collectMetadata('edit');
      const editCategorySelect = document.getElementById('editCategory');
      const editCategoryValue = editCategorySelect ? editCategorySelect.value : '';
      const knowledge = {
        title: document.getElementById('editTitle').value.trim(),
        url: document.getElementById('editUrl').value.trim(),
        comment: getMarkdownValue(editMarkdownEditor, 'editComment'),
        postedBy: document.getElementById('editPostedBy').value.trim(),
        thumbnailUrl: document.getElementById('editThumbnailUrl').value.trim(),
        tags: editTagValues,
        category: editCategoryValue,
        metadata: editMetadata,
      };

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!knowledge.title || !knowledge.url || !knowledge.postedBy) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã€URLã€æŠ•ç¨¿è€…ã¯å¿…é ˆé …ç›®ã§ã™');
        return;
      }

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const submitButton = event.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'æ›´æ–°ä¸­...';

      google.script.run
        .withSuccessHandler(function (result) {
          try {
            const response = typeof result === 'string' ? JSON.parse(result) : result;
            if (response.success) {
              closeEditModal();
              closeModal(); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚é–‰ã˜ã‚‹
              loadKnowledge(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
              alert('ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
            } else {
              alert('ã‚¨ãƒ©ãƒ¼: ' + (response.error || 'ãƒŠãƒ¬ãƒƒã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('ãƒŠãƒ¬ãƒƒã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .withFailureHandler(function (error) {
          console.error('Error updating knowledge:', error);
          alert('ã‚¨ãƒ©ãƒ¼: ' + (error?.message || 'ãƒŠãƒ¬ãƒƒã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        })
        .updateKnowledge(knowledgeId, knowledge);
    }
  </script>
